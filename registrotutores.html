<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Usu√°rio</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');
    body { font-family: Arial, sans-serif; line-height: 1.6; background:#f7f7f7; margin:10px; }
    header { justify-content:center; display:flex; background:#fff; padding:20px 0; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    header img { width:30px; height:30px; }
    nav { display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:0 auto; padding:0 20px; }
    nav .logo { font-size:1.5em; font-weight:bold; color:#e2725b; text-decoration:none; }
    nav ul { list-style:none; display:flex; gap:15px; }
    nav ul li a { text-decoration:none; color:#333; font-weight:bold; }

    .container { margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,.1); width:320px; margin-top:20px; }
    h2 { text-align:center; margin-bottom:20px; color:#d35e46; font-family: Parkinsans, sans-serif; }
    label { display:block; margin-bottom:8px; }
    input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="number"], select {
      width:100%; padding:10px; margin-bottom:12px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;
    }

    #pet-options label{ display:block; margin-bottom:6px; line-height:1.2; }
    #quantidades-container{ margin-top:10px; padding-top:8px; border-top:1px solid #eee; }
    #quantidades-container label{ font-size:.9em; margin-top:6px; }
    #total-pets{ font-size:.9em; font-weight:bold; margin-top:10px; text-align:center; color:#333; }
    #total-pets span{ color:#e2725b; }

    #idade-calculada{ text-align:center; font-size:.9em; color:#333; margin-top:-6px; margin-bottom:8px; }
    .age-note{ color:#F00; margin-top:-8px; margin-bottom:12px; font-size:.9em; text-align:center; display:none; }

    button{
      width:80%; border:2px solid #e2725b; border-radius:20px; display:flex; justify-content:center;
      margin:14px auto 0; padding:10px; background:#e2725b; color:#fff; cursor:pointer; font-size:16px; transition:background .3s;
      font-weight: 700;
    }
    button[disabled]{ opacity:.7; cursor:not-allowed; }
    button:hover{ background:#d45f47; }

    .criar{ display:flex; justify-content:center; margin-top:8px; }
    .criar a{ text-align:center; width:70%; color:black; padding:5px; border-radius:20px; text-decoration:none; }
    .criar a:hover{ color:#F00; }

    .msg { text-align:center; font-size:.95em; margin-top:8px; min-height:1.2em; }

    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; z-index: 999;
    }
    .modal{
      width: min(720px, 92vw); max-height: 86vh; overflow: hidden; background:#fff; border-radius:16px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      display:flex; flex-direction:column;
      font-family: Nunito, Arial, sans-serif;
    }
    .modal header{
      display:flex; align-items:center; justify-content:space-between; padding:14px 16px; box-shadow:none; border-bottom:1px solid #eee; background:#fff;
    }
    .modal h3{ margin:0; font-size:1.1rem; color:#333; }
    .modal .modal-body{
      padding:16px; overflow:auto; line-height:1.55; font-size:.95rem;
    }
    .modal footer{
      display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #eee; background:#fafafa;
    }

    .link-termos{
      font-size:.9rem; color:#0b69c7; text-decoration:underline; cursor:pointer;
    }
    .termos-check{ display:flex; align-items:flex-start; gap:8px; font-size:.9rem; margin:8px 0 12px; }
    .pill{
      display:inline-block; font-size:.72rem; background:#f1f5f9; color:#334155; border:1px solid #e2e8f0;
      padding:2px 8px; border-radius:999px; margin-right:6px;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="Icone">
      <a href="index.html" class="logo" style="font-family: Parkinsans;">Patas Pousada</a>
      <ul>
        <li><a href="index.html" style="font-family: Parkinsans;">In√≠cio</a></li>
        <li><a href="ajuda.html" style="font-family: Parkinsans;">Ajuda</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <h2>Cadastro</h2>

    <form id="formCadastro">
      <label for="name">Nome:</label>
      <input type="text" id="name" required placeholder="Informe seu nome completo">

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" required placeholder="000.000.000-00">

      <label for="birth_date">Data de Nascimento:</label>
      <input type="date" id="birth_date" required>
      <p id="idade-calculada"></p>
      <div class="age-note" id="mensagem-idade">‚ö†Ô∏è Idade inv√°lida. √â necess√°rio ter entre 18 e 100 anos.</div>

      <label for="email">E-mail:</label>
      <input type="email" id="email" required placeholder="Informe seu email">

      <label for="password">Senha:</label>
      <input type="password" id="password" required placeholder="Crie uma senha">

      <label for="confirm_password">Confirmar Senha:</label>
      <input type="password" id="confirm_password" required placeholder="Repita sua senha">

      <label>Que tipo de pet voc√™ tem?</label>
      <div id="pet-options"></div>
      <div id="quantidades-container"></div>

      <p id="total-pets">üêæ Total: <span>0</span> pets</p>

      <input type="text" id="other_pet" placeholder="Especifique o tipo de pet" style="display:none; margin-top:8px;">

      <div class="termos-check">
        <input type="checkbox" id="terms_consent" />
        <label for="terms_consent">
          Declaro que <strong>li e concordo</strong> com os
          <span id="open-terms" class="link-termos">Termos de Uso &amp; Consentimento de Dados (Brasil)</span>.
        </label>
      </div>

      <button type="submit" id="btn-registrar" disabled>Registrar</button><br>

      <div class="criar"><a href="cadastrarouentrar.html">J√° tenho uma conta</a></div>
      
      <div class="msg" id="msg"></div>
    </form>
  </div>

  <!-- Modal Termos -->
  <div id="termos-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="termos-title">
      <header>
        <h3 id="termos-title">Termos de Uso & Consentimento de Dados ‚Äî Patas Pousada (v1.1)</h3>
        <button type="button" id="close-terms" aria-label="Fechar" style="border:none;background:transparent;font-size:1.2rem;cursor:pointer;">‚úï</button>
      </header>

      <div class="modal-body">
        <p><span class="pill">Brasil</span><span class="pill">LGPD</span><span class="pill">Marco Civil</span><span class="pill">CDC</span></p>
        <h4>1. Objeto do servi√ßo</h4>

        <p>Conectamos tutores e anfitri√µes de pets como um marketplace.</p>

        <div style="margin-top:12px; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px;">
          <label style="display:flex; gap:8px; align-items:flex-start;">
            <input type="checkbox" id="modal_accept">
            <span>Li e concordo com os Termos de Uso & Consentimento de Dados.</span>
          </label>
        </div>
      </div>

      <footer>
        <button type="button" id="btn-decline">Cancelar</button>
        <button type="button" id="btn-accept" style="background:#e2725b;color:#fff;border:2px solid #e2725b;">Concordo e fechar</button>
      </footer>
    </div>
  </div>

  <!-- =============================== -->
  <!--     SUPABASE + L√ìGICA JS        -->
  <!-- =============================== -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://nwbgzokttjgkipwzfgzc.supabase.co";
    const supabaseAnon =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53Ymd6b2t0dGpna2lwd3pmZ3pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NjAyOTAsImV4cCI6MjA3NjIzNjI5MH0.jSdZ7TT8lH5y1P79VuFBOhOzNT1_5DG_aQk1fmyzmnk";

    const supabase = createClient(supabaseUrl, supabaseAnon);

    const msgDiv = document.getElementById("msg");
    const petLabels = {
      cachorro: "Cachorro",
      gato: "Gato",
      passaro: "P√°ssaro",
      roedor: "Roedor",
      reptil: "R√©ptil",
      outro: "Outro"
    };

    window.addEventListener("DOMContentLoaded", () => {
      gerarTiposPets();
      atualizarEstadoBotao();
    });

    /* ===============================
       PETS
    =============================== */
    function gerarTiposPets() {
      const container = document.getElementById("pet-options");
      const tipos = Object.keys(petLabels);

      tipos.forEach(tipo => {
        const label = document.createElement("label");
        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = tipo;
        input.addEventListener("change", () => {
          toggleOtherPetInput();
          gerarCamposQuantidade();
        });
        label.appendChild(input);
        label.append(" " + petLabels[tipo]);
        container.appendChild(label);
      });
    }

    function toggleOtherPetInput() {
      const inputs = document.querySelectorAll("#pet-options input");
      const otherPet = document.getElementById("other_pet");

      let ativo = false;
      inputs.forEach(i => {
        if (i.value === "outro" && i.checked) ativo = true;
      });

      otherPet.style.display = ativo ? "block" : "none";
      otherPet.required = ativo;
      gerarCamposQuantidade();
    }

    function gerarCamposQuantidade() {
      const selecionados = Array.from(document.querySelectorAll("#pet-options input:checked"));
      const container = document.getElementById("quantidades-container");
      container.innerHTML = "";

      selecionados.forEach(sel => {
        const tipo = sel.value;
        const label = document.createElement("label");

        if (tipo !== "outro") {
          label.textContent = `Quantos ${petLabels[tipo]}?`;

          const input = document.createElement("input");
          input.type = "number";
          input.min = 1;
          input.name = `qtd_${tipo}`;
          input.required = true;
          input.placeholder = "Ex: 2";
          input.addEventListener("input", atualizarTotal);

          container.appendChild(label);
          container.appendChild(input);
        } else {
          const otherName = document.getElementById("other_pet").value.trim() || "pets (Outro)";
          label.textContent = `Quantos ${otherName}?`;

          const input = document.createElement("input");
          input.type = "number";
          input.min = 1;
          input.name = "qtd_outro";
          input.required = true;
          input.placeholder = "Ex: 1";
          input.addEventListener("input", atualizarTotal);

          container.appendChild(label);
          container.appendChild(input);
        }
      });

      atualizarTotal();
    }

    function atualizarTotal() {
      const nums = document.querySelectorAll("#quantidades-container input");
      let total = 0;

      nums.forEach(n => {
        const v = parseInt(n.value);
        if (v > 0) total += v;
      });

      document.querySelector("#total-pets span").textContent = total;
    }

    /* ===============================
       IDADE E TERMOS
    =============================== */
    const birthInput = document.getElementById("birth_date");
    const idadeTexto = document.getElementById("idade-calculada");
    const msgIdade = document.getElementById("mensagem-idade");
    const botao = document.getElementById("btn-registrar");

    birthInput.addEventListener("input", () => {
      const nasc = new Date(birthInput.value);
      const hoje = new Date();
      let idade = hoje.getFullYear() - nasc.getFullYear();
      const m = hoje.getMonth() - nasc.getMonth();

      if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;

      if (!birthInput.value) {
        idadeTexto.textContent = "";
        msgIdade.style.display = "none";
        atualizarEstadoBotao();
        return;
      }

      idadeTexto.textContent = `üéÇ Sua idade: ${idade} anos`;

      if (idade < 18 || idade > 100) {
        msgIdade.style.display = "block";
        idadeTexto.style.color = "#c00";
      } else {
        msgIdade.style.display = "none";
        idadeTexto.style.color = "#333";
      }

      atualizarEstadoBotao();
    });

    function idadeValida() {
      const nasc = new Date(birthInput.value);
      if (!birthInput.value) return false;

      const hoje = new Date();
      let idade = hoje.getFullYear() - nasc.getFullYear();
      const m = hoje.getMonth() - nasc.getMonth();

      if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
      return idade >= 18 && idade <= 100;
    }

    function atualizarEstadoBotao() {
      const termos = document.getElementById("terms_consent").checked;
      const idadeOk = idadeValida();

      if (birthInput.value && !idadeOk) {
        botao.disabled = true;
        botao.style.backgroundColor = "#ccc";
        botao.style.borderColor = "#aaa";
        return;
      }

      botao.disabled = !termos;
      botao.style.backgroundColor = termos ? "#e2725b" : "#ccc";
      botao.style.borderColor = termos ? "#e2725b" : "#aaa";
    }

    document.getElementById("terms_consent").addEventListener("change", atualizarEstadoBotao);

    /* ===============================
       MODAL TERMOS
    =============================== */
    const openTerms = document.getElementById("open-terms");
    const backdrop = document.getElementById("termos-backdrop");
    const closeBtn = document.getElementById("close-terms");
    const btnDecline = document.getElementById("btn-decline");
    const btnAccept = document.getElementById("btn-accept");
    const modalAccept = document.getElementById("modal_accept");

    openTerms.addEventListener("click", e => {
      e.preventDefault();
      backdrop.style.display = "flex";
    });
    closeBtn.addEventListener("click", () => (backdrop.style.display = "none"));
    btnDecline.addEventListener("click", () => (backdrop.style.display = "none"));

    btnAccept.addEventListener("click", () => {
      if (!modalAccept.checked) {
        alert("Voc√™ precisa marcar que concorda com os termos.");
        return;
      }
      document.getElementById("terms_consent").checked = true;
      backdrop.style.display = "none";
      atualizarEstadoBotao();
    });

    /* ===============================
       SUBMIT PARA SUPABASE (VERCEL READY)
    =============================== */
    document.getElementById("formCadastro").addEventListener("submit", async (e) => {
      e.preventDefault();
      msgDiv.style.color = "red";
      msgDiv.textContent = "";

      const nome = document.getElementById("name").value.trim();
      let cpf = document.getElementById("cpf").value.replace(/\D/g, "");
      const birth = document.getElementById("birth_date").value;
      const email = document.getElementById("email").value.trim().toLowerCase();
      const senha = document.getElementById("password").value;
      const confirma = document.getElementById("confirm_password").value;

      if (senha !== confirma) {
        msgDiv.textContent = "As senhas n√£o coincidem.";
        return;
      }

      const idade = idadeValida();
      if (!idade) {
        msgDiv.textContent = "Idade inv√°lida.";
        return;
      }

      // total de pets
      const totalPets = parseInt(document.querySelector("#total-pets span").textContent);

      botao.textContent = "Cadastrando...";
      botao.disabled = true;

      try {
        // 1) criar conta no Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
          email,
          password: senha,
          options: {
            data: { full_name: nome, role: "tutor", cpf }
          }
        });

        if (authError) {
          msgDiv.textContent = authError.message;
          botao.textContent = "Registrar";
          botao.disabled = false;
          return;
        }

        const user = authData.user;
        if (!user) {
          msgDiv.textContent = "Erro inesperado ao criar usu√°rio.";
          botao.textContent = "Registrar";
          botao.disabled = false;
          return;
        }

        // 2) inserir no profiles
        const { error: insertError } = await supabase
          .from("profiles")
          .insert({
            id: user.id,
            full_name: nome,
            cpf,
            birth_date: birth,
            email,
            role: "tutor",
            pets_count: totalPets
          });

        if (insertError) {
          msgDiv.textContent = insertError.message;
          botao.textContent = "Registrar";
          botao.disabled = false;
          return;
        }

        msgDiv.style.color = "green";
        msgDiv.textContent = "Cadastro realizado! Redirecionando...";

        setTimeout(() => {
          window.location.href = "home_tutor.html";
        }, 1500);

      } catch (e) {
        msgDiv.textContent = "Erro inesperado: " + e.message;
      }

      botao.textContent = "Registrar";
      botao.disabled = false;
    });
  </script>

</body>
</html>
