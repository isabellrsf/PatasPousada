<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Usu√°rio</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');
    body { font-family: Arial, sans-serif; line-height: 1.6; background:#f7f7f7; margin:10px; }
    header { justify-content:center; display:flex; background:#fff; padding:20px 0; box-shadow:0 2px 4px rgba(0,0,0,.1); }
    header img { width:30px; height:30px; }
    nav { display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:0 auto; padding:0 20px; }
    nav .logo { font-size:1.5em; font-weight:bold; color:#e2725b; text-decoration:none; }
    nav ul { list-style:none; display:flex; gap:15px; }
    nav ul li a { text-decoration:none; color:#333; font-weight:bold; }

    .container { margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,.1); width:320px; margin-top:20px; }
    h2 { text-align:center; margin-bottom:20px; color:#d35e46; font-family: Parkinsans, sans-serif; }
    label { display:block; margin-bottom:8px; }
    input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="number"], select {
      width:100%; padding:10px; margin-bottom:12px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;
    }

    /* pets */
    #pet-options label{ display:block; margin-bottom:6px; line-height:1.2; }
    #quantidades-container{ margin-top:10px; padding-top:8px; border-top:1px solid #eee; }
    #quantidades-container label{ font-size:.9em; margin-top:6px; }
    #total-pets{ font-size:.9em; font-weight:bold; margin-top:10px; text-align:center; color:#333; }
    #total-pets span{ color:#e2725b; }

    /* idade */
    #idade-calculada{ text-align:center; font-size:.9em; color:#333; margin-top:-6px; margin-bottom:8px; }
    .age-note{ color:#F00; margin-top:-8px; margin-bottom:12px; font-size:.9em; text-align:center; display:none; }

    button{
      width:80%; border:2px solid #e2725b; border-radius:20px; display:flex; justify-content:center;
      margin:14px auto 0; padding:10px; background:#e2725b; color:#fff; cursor:pointer; font-size:16px; transition:background .3s;
      font-weight: 700;
    }
    button[disabled]{ opacity:.7; cursor:not-allowed; }
    button:hover{ background:#d45f47; }

    .criar{ display:flex; justify-content:center; margin-top:8px; }
    .criar a{ text-align:center; width:70%; color:black; padding:5px; border-radius:20px; text-decoration:none; }
    .criar a:hover{ color:#F00; }

    .msg { text-align:center; font-size:.95em; margin-top:8px; min-height:1.2em; }

    /* === MODAL TERMOS === */
    .modal-backdrop{
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; z-index: 999;
    }
    .modal{
      width: min(720px, 92vw); max-height: 86vh; overflow: hidden; background:#fff; border-radius:16px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
      display:flex; flex-direction:column;
      font-family: Nunito, Arial, sans-serif;
    }
    .modal header{
      display:flex; align-items:center; justify-content:space-between; padding:14px 16px; box-shadow:none; border-bottom:1px solid #eee; background:#fff;
    }
    .modal h3{ margin:0; font-size:1.1rem; color:#333; }
    .modal .modal-body{
      padding:16px; overflow:auto; line-height:1.55; font-size:.95rem;
    }
    .modal footer{
      display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #eee; background:#fafafa;
    }
    .link-termos{
      font-size:.9rem; color:#0b69c7; text-decoration:underline; cursor:pointer;
    }
    .termos-check{ display:flex; align-items:flex-start; gap:8px; font-size:.9rem; margin:8px 0 12px; }
    .pill{
      display:inline-block; font-size:.72rem; background:#f1f5f9; color:#334155; border:1px solid #e2e8f0;
      padding:2px 8px; border-radius:999px; margin-right:6px;
    }
    .bullet { margin-left: 1rem; }
  </style>
</head>
<body>
  <header>
    <nav>
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="Icone">
      <a href="index.html" class="logo" style="font-family: Parkinsans;">Patas Pousada</a>
      <ul>
        <li><a href="index.html" style="font-family: Parkinsans;">In√≠cio</a></li>
        <li><a href="ajuda.html" style="font-family: Parkinsans;">Ajuda</a></li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <h2>Cadastro</h2>

    <form id="formCadastro">
      <label for="name">Nome:</label>
      <input type="text" id="name" name="name" required placeholder="Informe seu nome completo">

      <label for="cpf">CPF:</label>
      <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00">

      <label for="birth_date">Data de Nascimento:</label>
      <input type="date" id="birth_date" name="birth_date" required>
      <p id="idade-calculada"></p>
      <div class="age-note" id="mensagem-idade">‚ö†Ô∏è Idade inv√°lida. √â necess√°rio ter entre 18 e 100 anos.</div>

      <label for="email">E-mail:</label>
      <input type="email" id="email" name="email" required placeholder="Informe seu email">

      <label for="password">Senha:</label>
      <input type="password" id="password" name="password" required placeholder="Crie uma senha">

      <label for="confirm_password">Confirmar Senha:</label>
      <input type="password" id="confirm_password" name="confirm_password" required placeholder="Repita sua senha">

      <!-- === Pets do Tutor === -->
      <label>Que tipo de pet voc√™ tem?</label>
      <div id="pet-options"></div>
      <div id="quantidades-container"></div>

      <p id="total-pets">üêæ Total: <span>0</span> pets</p>

      <input type="text" id="other_pet" name="other_pet" placeholder="Especifique o tipo de pet" style="display:none; margin-top:8px;">

      <!-- === TERMOS: check + link para abrir modal === -->
      <div class="termos-check">
        <input type="checkbox" id="terms_consent" />
        <label for="terms_consent" style="user-select:none">
          Declaro que <strong>li e concordo</strong> com os
          <span id="open-terms" class="link-termos">Termos de Uso &amp; Consentimento de Dados (Brasil)</span>.
        </label>
      </div>

      <button type="submit" id="btn-registrar">Registrar</button><br>

      <div class="criar"><a href="cadastrarouentrar.html">J√° tenho uma conta</a></div>
      <div class="msg" id="msg"></div>
    </form>
  </div>

  <!-- === MODAL com Termos (LGPD, Marco Civil, CDC, etc.) === -->
  <div id="termos-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="termos-title">
      <header>
        <h3 id="termos-title">Termos de Uso & Consentimento de Dados ‚Äî Patas Pousada (v1.1)</h3>
        <button type="button" id="close-terms" aria-label="Fechar" style="border:none;background:transparent;font-size:1.2rem;cursor:pointer;">‚úï</button>
      </header>
      <div class="modal-body">
        <p><span class="pill">Brasil</span><span class="pill">LGPD</span><span class="pill">Marco Civil</span><span class="pill">CDC</span></p>

        <h4>1. Objeto do servi√ßo</h4>
        <p>Conectamos tutores e anfitri√µes de pets como um <em>marketplace</em>. N√£o controlamos ou garantimos an√∫ncios, condutas, acomoda√ß√µes ou servi√ßos de terceiros.</p>

        <h4>2. Requisitos e cadastro</h4>
        <ul class="bullet">
          <li>Voc√™ declara ser maior de 18 anos e fornecer dados verdadeiros.</li>
          <li>N√£o compartilhe suas credenciais. Voc√™ √© respons√°vel por manter seu acesso seguro.</li>
        </ul>

        <h4>3. Regras de uso & conduta</h4>
        <ul class="bullet">
          <li>Cumpra leis locais, normas sanit√°rias e regras dos an√∫ncios.</li>
          <li>√â vedado conte√∫do ilegal, fraudulento, discriminat√≥rio ou que infrinja direitos de terceiros.</li>
        </ul>

        <h4>4. Pagamentos, taxas e cancelamentos</h4>
        <p>Poder√£o existir taxas de servi√ßo e pol√≠ticas de cancelamento/reembolso definidas no an√∫ncio. Ao reservar, voc√™ aceita essas condi√ß√µes.</p>

        <h4>5. Avalia√ß√µes</h4>
        <p>Devem ser honestas e respeitosas. Podemos moder√°-las quando violarem estes Termos ou a legisla√ß√£o aplic√°vel.</p>

        <h4>6. Privacidade & Prote√ß√£o de Dados (LGPD)</h4>
        <p>Tratamos seus dados conforme a <strong>Lei 13.709/2018 (LGPD)</strong>. Principais pontos:</p>
        <ul class="bullet">
          <li><strong>Controlador:</strong> Patas Pousada (contato do Encarregado/DPO: <em>dpo@pataspousada.com.br</em> ‚Äî altere para o e-mail oficial).</li>
          <li><strong>Finalidades:</strong> cria√ß√£o e gest√£o de conta, seguran√ßa, preven√ß√£o a fraudes, suporte, personaliza√ß√£o, comunica√ß√£o transacional, cumprimento legal e melhoria do servi√ßo.</li>
          <li><strong>Bases legais:</strong> consentimento; execu√ß√£o de contrato; cumprimento de obriga√ß√£o legal/regulat√≥ria; leg√≠timo interesse (ex.: seguran√ßa, m√©tricas); exerc√≠cio regular de direitos.</li>
          <li><strong>Direitos do titular:</strong> confirma√ß√£o, acesso, corre√ß√£o, anonimiza√ß√£o, bloqueio/elimina√ß√£o, portabilidade, informa√ß√£o sobre compartilhamentos e revoga√ß√£o do consentimento.</li>
          <li><strong>Compartilhamento:</strong> com processadores (provedores de nuvem, autentica√ß√£o, pagamento) sob contrato e medidas de seguran√ßa; autoridades quando exigido.</li>
          <li><strong>Transfer√™ncia internacional:</strong> pode ocorrer mediante salvaguardas adequadas (cl√°usulas padr√£o, certifica√ß√µes) e avalia√ß√£o de risco.</li>
          <li><strong>Reten√ß√£o:</strong> mantemos dados pelo tempo necess√°rio √†s finalidades e prazos legais (ex.: cont√°bil, defesa de direitos) e depois eliminamos ou anonimizamos.</li>
          <li><strong>Seguran√ßa:</strong> medidas t√©cnicas e organizacionais razo√°veis (criptografia em tr√¢nsito, controles de acesso, registro de eventos). Nenhuma plataforma √© 100% imune a incidentes.</li>
          <li><strong>Cookies/analytics:</strong> usamos para funcionalidades, seguran√ßa e m√©tricas. Voc√™ pode ajustar prefer√™ncias no navegador; algumas fun√ß√µes podem ser impactadas.</li>
          <li><strong>Comunica√ß√µes:</strong> e-mails transacionais e avisos operacionais. Marketing √© opcional e pode ser revogado.</li>
          <li><strong>Atendimento LGPD:</strong> para solicita√ß√µes, contate o DPO. Responderemos nos prazos legais.</li>
        </ul>

        <h4>7. Marco Civil da Internet</h4>
        <p>Observamos a <strong>Lei 12.965/2014</strong>, incluindo guarda de registros, prote√ß√£o de dados e neutralidade de rede.</p>

        <h4>8. Rela√ß√µes de consumo</h4>
        <p>Aplicam-se princ√≠pios do <strong>C√≥digo de Defesa do Consumidor (Lei 8.078/1990)</strong> e do <strong>Decreto 7.962/2013</strong> (com√©rcio eletr√¥nico), quando cab√≠vel.</p>

        <h4>9. Responsabilidades e Limita√ß√µes</h4>
        <ul class="bullet">
          <li><strong>Responsabilidade do usu√°rio:</strong> voc√™ √© exclusivamente respons√°vel pelas informa√ß√µes que fornece, pela veracidade de seus dados, pelas decis√µes de contrata√ß√£o e pela supervis√£o e bem-estar do seu pet durante a estadia/servi√ßo.</li>
          <li><strong>Eventos alheios ao software:</strong> n√£o nos responsabilizamos por perdas, danos, acidentes, ferimentos, desaparecimentos ou quaisquer trag√©dias que n√£o decorram de erro de software da plataforma, <em>salvo quando exigido por lei</em>.</li>
          <li><strong>Terceiros:</strong> anfitri√µes e demais usu√°rios s√£o independentes. N√£o respondemos por atos, omiss√µes ou conduta de terceiros.</li>
          <li><strong>For√ßa maior:</strong> n√£o nos responsabilizamos por eventos fora do nosso controle razo√°vel (ex.: interrup√ß√µes de internet, desastres, decis√µes governamentais).</li>
          <li><strong>Limita√ß√£o:</strong> na medida permitida pela lei, nossa responsabilidade total por danos diretos relacionados ao uso da plataforma se limita aos valores que voc√™ nos pagou pelos servi√ßos diretamente prestados por n√≥s nos 12 meses anteriores ao evento.</li>
        </ul>

        <h4>10. Atualiza√ß√µes</h4>
        <p>Podemos atualizar estes Termos e a Pol√≠tica de Privacidade. Mudan√ßas materiais ser√£o comunicadas; o uso cont√≠nuo ap√≥s a atualiza√ß√£o indica concord√¢ncia.</p>

        <div style="margin-top:12px; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px;">
          <label style="display:flex; gap:8px; align-items:flex-start;">
            <input type="checkbox" id="modal_accept">
            <span>Li e concordo com os Termos de Uso & Consentimento de Dados (Brasil), incluindo LGPD, Marco Civil da Internet e CDC, e reconhe√ßo minhas responsabilidades como usu√°rio.</span>
          </label>
        </div>
      </div>
      <footer>
        <button type="button" id="btn-decline" style="background:#fff;color:#111;border:1px solid #ddd;border-radius:10px;padding:8px 14px;cursor:pointer;">Cancelar</button>
        <button type="button" id="btn-accept" style="background:#e2725b;color:#fff;border:2px solid #e2725b;border-radius:10px;padding:8px 14px;cursor:pointer;font-weight:700;">Concordo e fechar</button>
      </footer>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ====== PETS: UI ======
    document.addEventListener("DOMContentLoaded", () => { gerarTiposPets(); });

    const TIPO_LABEL = {
      cachorro: "Cachorro",
      gato: "Gato",
      passaro: "P√°ssaro",
      roedor: "Roedor",
      reptil: "R√©ptil",
      outro: "Outro"
    };

    function gerarTiposPets(){
      const container = document.getElementById("pet-options");
      const tipos = ["cachorro","gato","passaro","roedor","reptil","outro"];
      tipos.forEach((tipo)=>{
        const label=document.createElement("label");
        const input=document.createElement("input");
        input.type="checkbox"; input.name="pet_type[]"; input.value=tipo;
        input.addEventListener("change",()=>{ toggleOtherPetInput(); gerarCamposQuantidade(); });
        label.appendChild(input); label.append(" "+TIPO_LABEL[tipo]);
        container.appendChild(label);
      });
    }

    function toggleOtherPetInput(){
      const inputs = document.querySelectorAll("input[name='pet_type[]']");
      const otherPet = document.getElementById("other_pet");
      let outroMarcado = false;
      inputs.forEach(i => { if(i.value === "outro" && i.checked) outroMarcado = true; });
      otherPet.style.display = outroMarcado ? "block" : "none";
      otherPet.required = outroMarcado;
      gerarCamposQuantidade();
    }

    function gerarCamposQuantidade(){
      const selecionados = Array.from(document.querySelectorAll("input[name='pet_type[]']:checked"));
      const container = document.getElementById("quantidades-container");
      container.innerHTML = "";

      selecionados.forEach(sel=>{
        const tipo = sel.value;

        if(tipo !== "outro"){
          const label = document.createElement("label");
          label.textContent = `Quantos ${TIPO_LABEL[tipo]}${tipo.endsWith("s") ? "?" : "s?"}`;

          const input = document.createElement("input");
          input.type = "number";
          input.name = `quantidade_${tipo}`;
          input.min = 1;
          input.required = true;
          input.placeholder = "Ex: 2";
          input.style.marginBottom = "8px";
          input.addEventListener("input", atualizarTotal);

          container.appendChild(label);
          container.appendChild(input);
        }

        if(tipo === "outro"){
          const outroNome = document.getElementById("other_pet").value.trim();
          const label = document.createElement("label");
          label.id = "label_quantidade_outro";
          label.textContent = `Quantos ${outroNome ? outroNome : "pets (Outro)"}?`;

          const input = document.createElement("input");
          input.type = "number";
          input.name = `quantidade_outro`;
          input.min = 1;
          input.required = true;
          input.placeholder = "Ex: 1";
          input.style.marginBottom = "8px";
          input.addEventListener("input", atualizarTotal);

          container.appendChild(label);
          container.appendChild(input);

          const otherPet = document.getElementById("other_pet");
          if (otherPet.__update_outro_label__) {
            otherPet.removeEventListener("input", otherPet.__update_outro_label__);
          }
          otherPet.__update_outro_label__ = function(){
            const novoNome = otherPet.value.trim();
            const lbl = document.getElementById("label_quantidade_outro");
            if(lbl){ lbl.textContent = `Quantos ${novoNome ? novoNome : "pets (Outro)"}?`; }
          };
          otherPet.addEventListener("input", otherPet.__update_outro_label__);
        }
      });

      atualizarTotal();
    }

    function atualizarTotal(){
      const inputs = document.querySelectorAll("#quantidades-container input[type='number']");
      let soma = 0;
      let valido = true;

      inputs.forEach(input=>{
        const valor = parseInt(input.value, 10);
        if(valor > 0) soma += valor;
        else if(input.value !== "") valido = false;
      });

      const totalDisplay = document.querySelector("#total-pets span");
      const totalTexto = document.getElementById("total-pets");

      if(!valido){
        totalDisplay.textContent = "‚ö†Ô∏è valor inv√°lido";
        totalTexto.style.color = "#c00";
      } else {
        totalDisplay.textContent = soma;
        totalTexto.style.color = soma > 0 ? "#333" : "#999";
      }
    }

    // ====== IDADE ======
    const birthInput = document.getElementById("birth_date");
    const idadeTexto = document.getElementById("idade-calculada");
    const msgIdade   = document.getElementById("mensagem-idade");
    const botao      = document.getElementById("btn-registrar");

    function idadeValida(){
      const birthDate=new Date(birthInput.value);
      if(!birthInput.value) return false;
      const hoje=new Date();
      let idade=hoje.getFullYear()-birthDate.getFullYear();
      const mes=hoje.getMonth()-birthDate.getMonth();
      if(mes<0 || (mes===0 && hoje.getDate()<birthDate.getDate())) idade--;
      return idade>=18 && idade<=100;
    }

    function atualizarEstadoBotao(){
      const termosOk = document.getElementById('terms_consent').checked;
      const idadeOk  = idadeValida();
      if(!idadeOk){
        botao.disabled = true;
        botao.style.backgroundColor="#ccc"; botao.style.borderColor="#aaa"; botao.style.cursor="not-allowed";
        return;
      }
      botao.disabled = !termosOk;
      botao.style.backgroundColor = termosOk ? "#e2725b" : "#ccc";
      botao.style.borderColor     = termosOk ? "#e2725b" : "#aaa";
      botao.style.cursor          = termosOk ? "pointer" : "not-allowed";
    }

    birthInput.addEventListener("input", ()=>{
      const birthDate=new Date(birthInput.value);
      const hoje=new Date();
      let idade=hoje.getFullYear()-birthDate.getFullYear();
      const mes=hoje.getMonth()-birthDate.getMonth();
      if(mes<0 || (mes===0 && hoje.getDate()<birthDate.getDate())) idade--;
      if(!birthInput.value){ idadeTexto.textContent=""; msgIdade.style.display="none"; atualizarEstadoBotao(); return; }
      idadeTexto.textContent=`üéÇ Sua idade: ${idade} anos`;
      if(idade<18 || idade>100){
        msgIdade.style.display="block"; idadeTexto.style.color="#c00";
      } else {
        msgIdade.style.display="none"; idadeTexto.style.color="#333";
      }
      atualizarEstadoBotao();
    });

    // === TERMOS: abrir/fechar modal e sincronizar checks ===
    const chkPrincipal = document.getElementById('terms_consent');
    const openTerms = document.getElementById('open-terms');
    const backdrop  = document.getElementById('termos-backdrop');
    const closeBtn  = document.getElementById('close-terms');
    const btnDecline= document.getElementById('btn-decline');
    const btnAccept = document.getElementById('btn-accept');
    const modalAccept = document.getElementById('modal_accept');

    function abrirTermos(){
      backdrop.style.display='flex';
      modalAccept.checked = false;
    }
    function fecharTermos(){
      backdrop.style.display='none';
    }

    openTerms.addEventListener('click', (e)=>{ e.preventDefault(); abrirTermos(); });
    closeBtn.addEventListener('click', fecharTermos);
    btnDecline.addEventListener('click', fecharTermos);

    btnAccept.addEventListener('click', ()=>{
      if(!modalAccept.checked){
        alert('Para prosseguir, marque ‚ÄúLi e concordo‚Äù nos Termos.');
        return;
      }
      chkPrincipal.checked = true;
      fecharTermos();
      atualizarEstadoBotao();
    });

    chkPrincipal.addEventListener('change', atualizarEstadoBotao);

    // ====== SUPABASE (signUp com metadados necess√°rios pro trigger)
    const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("formCadastro");
    const msg  = document.getElementById("msg");
    const btn  = document.getElementById("btn-registrar");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      if(!chkPrincipal.checked){
        msg.textContent = "Voc√™ precisa aceitar os Termos de Uso & Consentimento de Dados para concluir o cadastro.";
        atualizarEstadoBotao();
        return;
      }

      msg.textContent = "Enviando‚Ä¶";
      btn.disabled = true; btn.textContent = "Enviando‚Ä¶";

      const nome  = document.getElementById("name").value.trim();
      const cpf   = document.getElementById("cpf").value.trim().replace(/\D/g,'');
      const dataN = document.getElementById("birth_date").value;
      const email = document.getElementById("email").value.trim().toLowerCase();
      const pass  = document.getElementById("password").value;
      const conf  = document.getElementById("confirm_password").value;

      const marcados = Array.from(document.querySelectorAll("input[name='pet_type[]']:checked")).map(i=>i.value);
      const outroTxt = document.getElementById("other_pet").value.trim();

      const petTypes = marcados.includes("outro")
        ? [...marcados.filter(v=>v!=="outro"), ...(outroTxt ? [outroTxt] : ["outro"]) ]
        : marcados;

      const petCounts = {};
      marcados.forEach(v=>{
        if(v !== "outro"){
          const n = parseInt(document.querySelector(`input[name="quantidade_${v}"]`)?.value || "0", 10);
          if (n > 0) petCounts[v] = n;
        }
      });
      if (marcados.includes("outro")) {
        const nOutro = parseInt(document.querySelector(`input[name="quantidade_outro"]`)?.value || "0", 10);
        if (nOutro > 0) petCounts[outroTxt || "outro"] = nOutro;
      }

      const totalPets = Object.values(petCounts).reduce((a,b)=>a+b,0);

      if(pass !== conf){ msg.textContent = "As senhas n√£o coincidem."; btn.disabled=false; btn.textContent="Registrar"; return; }
      if(!nome || !cpf || !dataN || !email || !pass){ msg.textContent = "Preencha todos os campos."; btn.disabled=false; btn.textContent="Registrar"; return; }

      try {
        const consentVersion = "1.1";
        const consentAt = new Date().toISOString();

        const { data: sign, error: signErr } = await sb.auth.signUp({
          email, password: pass,
          options: {
            emailRedirectTo: 'https://patas-pousada.vercel.app/cadastrarouentrar.html?next=cadastroPets.html',
            data: {
              full_name: nome,
              role: 'tutor',
              cpf,
              birth_date: dataN,
              pet_types: petTypes,
              pet_counts: petCounts,
              has_pets_total: totalPets,
              consent_accepted: true,
              consent_version: consentVersion,
              consent_accepted_at: consentAt,
              consent_jurisdiction: "BR"
            }
          }
        });
        if (signErr) {
          msg.textContent = "Erro ao criar conta: " + signErr.message;
          btn.disabled=false; btn.textContent="Registrar";
          return;
        }

        const { data: sess } = await sb.auth.getSession();
        const session = sess?.session || null;

        if (!session) {
          msg.textContent = "Conta criada! Verifique seu e-mail para confirmar e depois fa√ßa login.";
          btn.disabled = false; btn.textContent = "Registrar";
          return;
        }

        msg.textContent = "Cadastro conclu√≠do! Redirecionando‚Ä¶";
        btn.textContent = "Sucesso!";
        setTimeout(()=> {
          window.location.href = "cadastroPets.html?sucesso=" + encodeURIComponent("Agora cadastre seus pets.");
        }, 700);

      } catch (err){
        console.error(err);
        msg.textContent = "Falha inesperada. Veja o console do navegador.";
        btn.disabled=false; btn.textContent="Registrar";
      }
    });

    atualizarEstadoBotao();
  </script>
</body>
</html>
