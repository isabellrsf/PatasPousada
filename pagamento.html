<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Patas Pousadas ‚Äî Pagamento</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Parkinsans:wght@400;700&display=swap" rel="stylesheet">

  <!-- CSS: exatamente igual ao seu -->
  <style>
    :root{
      --pri:#e2725b; --pri-dark:#d45f47; --bg:#f7f7f7; --card:#fff; --border:#e5e5e5;
      --txt:#222; --muted:#6b7280; --role-tutor:#b14946; --role-host:#a65351;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:Nunito,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt);}
    header{display:flex;justify-content:center;align-items:center;background:#fff;padding:20px 0;box-shadow:0 2px 4px rgba(0,0,0,.1);}
    nav{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:8px;}
    .logo{display:flex;align-items:center;gap:10px;font-family:'Parkinsans',sans-serif;font-size:1.6em;font-weight:800;color:var(--pri);text-decoration:none;}
    .logo img{width:30px;height:30px;margin-bottom:2px;}
    nav ul{list-style:none;display:flex;justify-content:center;gap:24px;margin-top:6px;padding:0;}
    nav ul li a{text-decoration:none;color:#1f2937;font-weight:700;font-family:'Parkinsans',sans-serif;transition:color .2s;}
    nav ul li a:hover{ color:var(--pri-dark); }
    main{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 10px 20px rgba(0,0,0,.06);max-width:720px;margin:0 auto;}
    h1{font-size:1.35rem;margin:0}
    .hint{color:var(--muted);margin:6px 0 16px}
    label{display:block;font-weight:800;margin:10px 0 6px}
    input{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:20px}
    button{all:unset;background:var(--pri);color:#fff;padding:12px 16px;border-radius:20px;font-weight:900;cursor:pointer;min-width:160px;text-align:center;}
    button:hover{background:var(--pri-dark)}
    .text-link{color:var(--pri);text-decoration:none;font-weight:900}
    .text-link:hover{text-decoration:underline}
    .small-links{display:flex;justify-content:center;gap:12px;margin-top:10px}
    .create-links{display:flex;flex-direction:column;align-items:flex-start;gap:8px;margin-top:20px;}
    .role-tutor{color:var(--role-tutor);font-weight:900;}
    .role-host{color:var(--role-host);font-weight:900;}
    .msg{margin-top:12px;padding:10px;border-radius:12px;font-weight:700;text-align:center;display:none}
    .msg.ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;display:block}
    .msg.err{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;display:block}
  </style>

  <!-- Supabase opcional -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <header>
    <nav>
      <a href="index.html" class="logo">
        <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="√çcone">
        Patas Pousada
      </a>
      <ul>
        <li><a href="index.html">In√≠cio</a></li>
        <li><a href="ajuda.html">Ajuda</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="card">
      <h1>Pagamento seguro üêæ</h1>
      <p class="hint">Revise sua reserva e escolha a forma de pagamento</p>

      <!-- Resumo -->
      <section id="resumo">
        <label>Resumo</label>
        <input id="resumo-linha" type="text" readonly value="Carregando resumo‚Ä¶">
        <div class="small-links">
          <a class="text-link" id="editar-reserva" href="index.html">Editar dados da reserva</a>
        </div>
      </section>

      <hr style="border:none;height:1px;background:var(--border);margin:16px 0;">

      <!-- M√©todo -->
      <section>
        <label>M√©todo de pagamento</label>
        <div id="metodos" style="display:flex;gap:16px;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:8px;font-weight:700;">
            <input type="radio" name="metodo" value="cartao" checked style="width:auto;" onchange="onMetodoChange()"> Cart√£o de cr√©dito
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-weight:700;">
            <input type="radio" name="metodo" value="pix" style="width:auto;" onchange="onMetodoChange()"> Pix
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-weight:700;">
            <input type="radio" name="metodo" value="boleto" style="width:auto;" onchange="onMetodoChange()"> Boleto
          </label>
        </div>
      </section>

      <!-- Dados comuns -->
      <section style="margin-top:8px;">
        <label for="email">E-mail para recibo</label>
        <input id="email" type="email" required placeholder="voce@exemplo.com">
        <label for="cpf">CPF do pagador</label>
        <input id="cpf" type="text" required placeholder="000.000.000-00">
      </section>

      <!-- Cart√£o -->
      <section id="bloco-cartao" style="display:none;margin-top:8px;">
        <label for="nome">Nome impresso no cart√£o</label>
        <input id="nome" type="text" placeholder="NOME COMPLETO">

        <label for="numero">N√∫mero do cart√£o</label>
        <input id="numero" inputmode="numeric" maxlength="19" placeholder="0000 0000 0000 0000">

        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div style="flex:1;min-width:140px;">
            <label for="validade">Validade (MM/AA)</label>
            <input id="validade" inputmode="numeric" maxlength="5" placeholder="MM/AA">
          </div>
          <div style="flex:1;min-width:140px;">
            <label for="cvv">CVV</label>
            <input id="cvv" inputmode="numeric" maxlength="4" placeholder="3 ou 4 d√≠gitos">
          </div>
        </div>

        <label for="parcelas">Parcelas</label>
        <input id="parcelas" type="number" min="1" max="12" value="1" placeholder="1 a 12">
      </section>

      <!-- Pix -->
      <section id="bloco-pix" style="display:none;margin-top:8px;">
        <label>C√≥digo Pix (copia e cola)</label>
        <input id="pix-copia" type="text" readonly value="">
        <div class="small-links">
          <a class="text-link" href="#" id="copiar-pix">Copiar c√≥digo Pix</a>
        </div>
      </section>

      <!-- Boleto -->
      <section id="bloco-boleto" style="display:none;margin-top:8px;">
        <label>Linha digit√°vel do boleto</label>
        <input id="boleto-linha" type="text" readonly value="">
        <div class="small-links" style="gap:16px;">
          <a class="text-link" href="#" id="copiar-boleto">Copiar linha</a>
          <a class="text-link" href="#" id="baixar-boleto">Baixar boleto (TXT)</a>
        </div>
        <div style="margin-top:12px;">
          <label>C√≥digo de barras (ilustrativo)</label>
          <canvas id="boleto-barcode" width="680" height="100" style="width:100%;background:#fff;border:1px solid var(--border);border-radius:12px;"></canvas>
          <p class="hint">Ilustrativo para UI; o escane√°vel real deve vir do gateway.</p>
        </div>
      </section>

      <!-- Aceite + link de termos -->
      <section style="margin-top:8px;">
        <label style="display:flex;gap:10px;align-items:flex-start;font-weight:700;">
          <input id="aceite" type="checkbox" style="width:auto;margin-top:4px;">
          <span>Eu li e aceito os termos da reserva e pol√≠tica de cancelamento.
            <a href="#" class="text-link" id="link-termos" style="margin-left:6px;">Ler termos</a>
          </span>
        </label>
      </section>

      <div class="actions">
        <button id="btn-pagar" type="button">Pagar agora</button>
        <a class="text-link" href="ajuda.html">Precisa de ajuda?</a>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </main>

  <!-- ===== Modal de Termos ===== -->
  <div id="termos-overlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:16px;z-index:9999;">
    <div role="dialog" aria-modal="true" aria-labelledby="termos-title"
         style="background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:820px;width:100%;max-height:85vh;overflow:auto;box-shadow:0 10px 24px rgba(0,0,0,.22);padding:20px;position:relative;">
      <button id="fechar-termos" aria-label="Fechar"
              style="all:unset;position:absolute;top:12px;right:12px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;color:#fff;background:var(--pri);font-weight:900;">√ó</button>

      <h2 id="termos-title" style="font-size:1.25rem;margin-bottom:8px;">Termos da Reserva</h2>
      <p class="hint" style="margin-bottom:12px;">Leia com aten√ß√£o antes de concluir o pagamento.</p>

      <div style="display:flex;flex-direction:column;gap:10px;">
        <p><strong>1. Confirma√ß√£o:</strong> reservas via cart√£o e Pix s√£o confirmadas ap√≥s autoriza√ß√£o/compensa√ß√£o. Boleto confirma ap√≥s compensa√ß√£o banc√°ria.</p>
        <p><strong>2. Cancelamento:</strong> at√© 7 dias corridos ap√≥s a compra (e antes do check-in) com reembolso integral; ap√≥s esse prazo, reembolsos podem ter taxas.</p>
        <p><strong>3. Regras do anfitri√£o:</strong> siga as pol√≠ticas do anfitri√£o (hor√°rios, √°reas permitidas, exig√™ncias de vacina√ß√£o etc.). O descumprimento pode resultar em multa e/ou t√©rmino da estadia.</p>
        <p><strong>4. Responsabilidade:</strong> declare que seu(s) pet(s) est√°(√£o) saud√°vel(s) e vacinado(s). Danos a propriedade/terceiros poder√£o ser cobrados.</p>
        <p><strong>5. Privacidade:</strong> usaremos seus dados apenas para processar a reserva e cumprir obriga√ß√µes legais. Veja nossa pol√≠tica de privacidade.</p>
        <p><strong>6. Altera√ß√µes:</strong> mudan√ßas de datas e h√≥spedes-pet est√£o sujeitas √† disponibilidade do anfitri√£o e eventuais diferen√ßas tarif√°rias.</p>
        <p><strong>7. No-show:</strong> aus√™ncia no check-in sem aviso pr√©vio pode ser tratada como cancelamento fora do prazo.</p>
      </div>

      <div class="actions" style="margin-top:16px;">
        <button id="btn-termos-aceitar" type="button">Aceitar termos</button>
        <button id="btn-termos-recusar" type="button" style="background:#fff;color:var(--pri);border:1px solid var(--pri);">Recusar</button>
      </div>
    </div>
  </div>
  <!-- ===== Fim Modal ===== -->

  <script>
    /* ===== Helpers UI ===== */
    function setMsg(el, text, ok=false){
      el.textContent = text;
      el.className = "msg " + (ok ? "ok":"err");
      el.style.display = text ? "block":"none";
    }
    function maskCard(v){ return v.replace(/\D/g,'').slice(0,16).replace(/(\d{4})(?=\d)/g,'$1 '); }
    function maskValidade(v){ v=v.replace(/\D/g,'').slice(0,4); if(v.length>=3) v=v.slice(0,2)+'/'+v.slice(2); return v; }
    function maskCPF(v){ return v.replace(/\D/g,'').slice(0,11).replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2'); }
    function luhnOk(num){
      const digits = num.replace(/\s+/g,'');
      if(digits.length < 13) return false;
      let sum=0, dbl=false;
      for(let i=digits.length-1;i>=0;i--){
        let d = +digits[i];
        if(dbl){ d*=2; if(d>9) d-=9; }
        sum+=d; dbl=!dbl;
      }
      return sum%10===0;
    }
    function validadeOk(v){
      if(!/^\d{2}\/\d{2}$/.test(v)) return false;
      const [mm,aa]=v.split('/').map(Number);
      if(mm<1||mm>12) return false;
      const now=new Date(), y=now.getFullYear()%100, m=now.getMonth()+1;
      if(aa<y) return false; if(aa===y && mm<m) return false; return true;
    }
    function formatCurrency(n){ return Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

    /* ===== PIX / Boleto (demo) ===== */
    function gerarPixCode({total, recebedor="Patas Pousadas LTDA", cidade="Brasilia", chave="contato@pataspousadas.com"}){
      const val=Number(total||0).toFixed(2);
      return `00020126580014BR.GOV.BCB.PIX0136${chave}5204000053039865407${val.replace('.','')}5802BR59${String(recebedor).length.toString().padStart(2,'0')}${recebedor}60${String(cidade).length.toString().padStart(2,'0')}${cidade}62070503***6304ABCD`;
    }
    function gerarLinhaBoleto({banco="341", moeda="9", total}){
      const valor = String(Math.round(Number(total||0)*100)).padStart(10,'0');
      const fator = "9999";
      const livre = "1234567890123456789012345";
      const barra44 = `${banco}${moeda}0${fator}${valor}${livre}`;
      const linha = `${barra44.slice(0,5)}.${barra44.slice(5,10)} ${barra44.slice(10,15)}.${barra44.slice(15,21)} ${barra44.slice(21,26)}.${barra44.slice(26,32)} ${barra44.slice(32,33)} ${barra44.slice(33)}`;
      return {barra44, linha};
    }
    function desenharBarcodeIlustrativo(canvas, digits){
      const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height;
      ctx.clearRect(0,0,W,H);
      const ml=20, mr=20, areaW=W-ml-mr;
      const bars=[]; for(let i=0;i<digits.length;i++){ const d=+digits[i]; bars.push({w:d%2?4:2,gap:2}); }
      const totalUnits=bars.reduce((s,b)=>s+b.w+b.gap,0); const unit=areaW/totalUnits;
      let x=ml; ctx.fillStyle='#000';
      for(const b of bars){ const bw=Math.max(1,Math.floor(b.w*unit)); ctx.fillRect(x,10,bw,H-30); x+=bw+Math.floor(b.gap*unit); }
      ctx.font='14px Nunito, Arial'; ctx.fillText(digits, ml, H-8);
    }

    /* ===== Elementos dos blocos ===== */
    const elCartao = document.getElementById('bloco-cartao');
    const elPix    = document.getElementById('bloco-pix');
    const elBoleto = document.getElementById('bloco-boleto');

    /* ===== Visibilidade por m√©todo ===== */
    function onMetodoChange(){
      const sel = document.querySelector('input[name="metodo"]:checked')?.value;
      elCartao.style.display = (sel==='cartao') ? 'block' : 'none';
      elPix.style.display    = (sel==='pix')    ? 'block' : 'none';
      elBoleto.style.display = (sel==='boleto') ? 'block' : 'none';
    }
    window.onMetodoChange = onMetodoChange;

    /* ===== Modal: abrir/fechar/aceitar/recusar ===== */
    const overlay = document.getElementById('termos-overlay');
    const linkTermos = document.getElementById('link-termos');
    const btnFechar = document.getElementById('fechar-termos');
    const btnAceitar = document.getElementById('btn-termos-aceitar');
    const btnRecusar = document.getElementById('btn-termos-recusar');
    const cbAceite = document.getElementById('aceite');

    function abrirTermos(e){
      if(e) e.preventDefault();
      overlay.style.display = 'flex';
    }
    function fecharTermos(){
      overlay.style.display = 'none';
    }
    function aceitarTermos(){
      cbAceite.checked = true;
      fecharTermos();
    }
    function recusarTermos(){
      cbAceite.checked = false;
      fecharTermos();
    }

    linkTermos.addEventListener('click', abrirTermos);
    btnFechar.addEventListener('click', fecharTermos);
    btnAceitar.addEventListener('click', aceitarTermos);
    btnRecusar.addEventListener('click', recusarTermos);

    // Fecha ao clicar fora do card
    overlay.addEventListener('click', (e)=>{
      if(e.target === overlay) fecharTermos();
    });
    // Fecha com ESC
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && overlay.style.display === 'flex') fecharTermos();
    });

    /* ===== Inicializa√ß√£o ===== */
    (function init(){
      const params=new URLSearchParams(location.search);
      const reserva=params.get('reserva')||'PP-0000';
      const checkin=params.get('checkin')||'‚Äî';
      const checkout=params.get('checkout')||'‚Äî';
      const pets=params.get('pets')||'1';
      const nomePet=params.get('nomePet')||'';
      const anfitriao=params.get('anfitriao')||'Anfitri√£o';
      const total=params.get('total')||'0';

      document.getElementById('resumo-linha').value =
        `Reserva ${reserva} ‚Ä¢ ${anfitriao} ‚Ä¢ ${pets} pet(s) ${nomePet?('('+nomePet+')'):''} ‚Ä¢ ${checkin} ‚Üí ${checkout} ‚Ä¢ Total ${formatCurrency(total)}`;
      document.getElementById('editar-reserva').href = `index.html?reserva=${encodeURIComponent(reserva)}`;

      // Preenche Pix/Boleto
      document.getElementById('pix-copia').value = gerarPixCode({ total });
      const { barra44, linha } = gerarLinhaBoleto({ total });
      document.getElementById('boleto-linha').value = linha;
      desenharBarcodeIlustrativo(document.getElementById('boleto-barcode'), barra44);

      // M√°scaras
      document.getElementById('numero').addEventListener('input', e=> e.target.value = maskCard(e.target.value));
      document.getElementById('validade').addEventListener('input', e=> e.target.value = maskValidade(e.target.value));
      document.getElementById('cpf').addEventListener('input', e=> e.target.value = maskCPF(e.target.value));

      // Copiar Pix/Boleto
      document.getElementById('copiar-pix').addEventListener('click', e=>{
        e.preventDefault();
        const inp=document.getElementById('pix-copia'); inp.select(); inp.setSelectionRange(0,99999);
        try{ document.execCommand('copy'); }catch{}
        setMsg(document.getElementById('msg'),'C√≥digo Pix copiado!', true);
      });
      document.getElementById('copiar-boleto').addEventListener('click', e=>{
        e.preventDefault();
        const inp=document.getElementById('boleto-linha'); inp.select(); inp.setSelectionRange(0,99999);
        try{ document.execCommand('copy'); }catch{}
        setMsg(document.getElementById('msg'),'Linha do boleto copiada!', true);
      });
      document.getElementById('baixar-boleto').addEventListener('click', e=>{
        e.preventDefault();
        const linha=document.getElementById('boleto-linha').value;
        const blob=new Blob([`Boleto Patas Pousadas\nLinha digit√°vel:\n${linha}\n\n(Arquivo de demonstra√ß√£o)`],{type:'text/plain'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a');
        a.href=url; a.download='boleto-pataspousadas.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      // Bot√£o pagar (simula√ß√£o)
      document.getElementById('btn-pagar').addEventListener('click', async ()=>{
        const msg=document.getElementById('msg');
        setMsg(msg,'Processando‚Ä¶', true);

        const sel=document.querySelector('input[name="metodo"]:checked')?.value||'cartao';
        const email=document.getElementById('email').value.trim();
        const cpf=document.getElementById('cpf').value.replace(/\D/g,'');
        if(!email){ setMsg(msg,'Informe um e-mail v√°lido.'); return; }
        if(cpf.length!==11){ setMsg(msg,'Informe um CPF v√°lido (11 d√≠gitos).'); return; }
        if(!document.getElementById('aceite').checked){
          setMsg(msg,'Voc√™ precisa aceitar os termos para continuar.');
          return;
        }

        if(sel==='cartao'){
          const numero=document.getElementById('numero').value;
          const validade=document.getElementById('validade').value;
          const cvv=document.getElementById('cvv').value;
          const nome=document.getElementById('nome').value.trim();
          const parcelas=+document.getElementById('parcelas').value||1;
          if(!nome){ setMsg(msg,'Informe o nome impresso no cart√£o.'); return; }
          if(!luhnOk(numero)){ setMsg(msg,'N√∫mero do cart√£o inv√°lido.'); return; }
          if(!validadeOk(validade)){ setMsg(msg,'Validade inv√°lida.'); return; }
          if(!(cvv.length===3||cvv.length===4)){ setMsg(msg,'CVV inv√°lido.'); return; }
          if(!(parcelas>=1 && parcelas<=12)){ setMsg(msg,'Parcelas devem estar entre 1 e 12.'); return; }
          await new Promise(r=>setTimeout(r,700));
          setMsg(msg,'Pagamento aprovado! Redirecionando‚Ä¶', true);
          setTimeout(()=>location.href='confirmacao.html?metodo=cartao',600);
          return;
        }
        if(sel==='pix'){
          await new Promise(r=>setTimeout(r,500));
          setMsg(msg,'Pix gerado! Fa√ßa o pagamento no seu banco. Confirmando‚Ä¶', true);
          setTimeout(()=>{ setMsg(msg,'Pagamento confirmado via Pix! Redirecionando‚Ä¶', true); location.href='confirmacao.html?metodo=pix'; }, 4000);
          return;
        }
        if(sel==='boleto'){
          await new Promise(r=>setTimeout(r,500));
          setMsg(msg,'Boleto gerado! A reserva confirma ap√≥s compensa√ß√£o.', true);
        }
      });

      // Estado inicial: mostrar cart√£o
      onMetodoChange();

      // Supabase opcional (n√£o bloqueia)
      try{
        if(window.supabase){
          const sb = window.supabase.createClient(
            "https://nwbgzokttjgkipwzfgzc.supabase.co",
            "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ"
          );
          sb.auth.getUser().then(({data:{user}})=>{
            if(user?.email) document.getElementById('email').value = user.email;
          }).catch(()=>{});
        }
      }catch(e){}
    })();
  </script>
</body>
</html>
