<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro de Pets</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Parkinsans:wght@400;700&display=swap');
    body{font-family:'Nunito',sans-serif;line-height:1.6;background:#f7f7f7;margin:0}
    header{justify-content:center;display:flex;background:#fff;padding:20px 0;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    header img{width:30px;height:30px}
    nav{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto;padding:0 20px}
    nav .logo{font-size:1.5em;font-weight:bold;color:#e2725b;text-decoration:none;font-family:'Parkinsans',sans-serif}
    nav ul{list-style:none;display:flex;gap:15px}
    nav ul li a{text-decoration:none;color:#333;font-weight:bold;font-family:'Parkinsans',sans-serif;transition:.3s}
    nav ul li a:hover{color:red}
    .container{margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1);width:320px;margin-top:20px;position:relative}
    h2{text-align:center;margin-bottom:20px;color:#e2725b;font-family:'Parkinsans',sans-serif}
    label{display:block;margin-bottom:8px}
    input[type="text"],input[type="number"],input[type="file"],select,textarea{width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
    textarea{resize:none;height:70px}
    .radio-group{margin-bottom:15px}
    .radio-group label{margin-right:10px}
    .preview{text-align:center;margin-bottom:15px}
    .preview img{width:100px;height:100px;object-fit:cover;border-radius:50%;border:2px solid #e2725b;display:none}
    .main-btn{width:80%;border:2px solid #e2725b;border-radius:20px;display:flex;justify-content:center;margin:auto;padding:10px;background:#e2725b;color:#fff;cursor:pointer;font-size:16px;margin-top:10px;transition:background .3s;font-family:'Parkinsans',sans-serif}
    .main-btn:hover{background:red}
    .add-pet{background:#fff;color:#e2725b;border:2px solid #e2725b}
    .add-pet:hover{background:#ffe6e6}
    .remove-pet-btn{background:none;border:none;color:#e2725b;font-size:18px;cursor:pointer;margin-left:5px;transition:transform .2s ease,color .2s ease;vertical-align:middle}
    .remove-pet-btn:hover{color:red;transform:scale(1.2)}
    .pet-card{position:relative;border:1px solid #eee;padding:15px;border-radius:8px;background:#fafafa;transition:all .3s ease;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:15px}
    .pet-card:hover{transform:translateY(-4px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .pet-card.fade-out{opacity:0;transform:translateY(-10px)}
    .criar{display:flex;justify-content:center;margin-top:15px}
    .criar a{text-align:center;width:70%;color:black;padding:5px;border-radius:20px;text-decoration:none}
    .criar a:hover{color:#F00}
    .pet-header{display:flex;justify-content:center;align-items:center;gap:6px;margin-bottom:10px}
    .alerta-sucesso{display:none;background:#ffe6e6;color:#cc0000;border:1px solid #e2725b;border-radius:8px;padding:12px;margin:20px auto;text-align:center;font-weight:bold;width:320px;opacity:0;transition:opacity .8s ease}
  </style>
</head>
<body>
  <header>
    <nav>
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="Icone">
      <a href="index.html" class="logo">Patas Pousada</a>
      <ul>
        <li><a href="index.html">In√≠cio</a></li>
        <li><a href="ajuda.html">Ajuda</a></li>
      </ul>
    </nav>
  </header>

  <div id="mensagem-sucesso" class="alerta-sucesso"></div>

  <div class="container">
    <h2>Cadastro de Pets üêæ</h2>

    <form id="formPets">
      <div id="form-container"></div>
      <button type="button" class="main-btn add-pet" id="btnAdd">+ Adicionar outro pet</button>
      <button type="submit" class="main-btn" id="salvar">Salvar Pets</button>
    </form>

    <div class="criar">
      <a href="dashboard.html">Voltar</a>
    </div>
  </div>

  <script>
    // Mensagem de sucesso (opcional)
    const params = new URLSearchParams(window.location.search);
    if (params.has("sucesso")) {
      const msg = decodeURIComponent(params.get("sucesso"));
      const div = document.getElementById("mensagem-sucesso");
      div.textContent = msg;
      div.style.display = "block";
      setTimeout(() => (div.style.opacity = "1"), 100);
      setTimeout(() => (div.style.opacity = "0"), 5000);
    }

    // ===== Form din√¢mico de pets =====
    let contadorPets = 0;
    function adicionarPet(){
      contadorPets++;
      const container = document.getElementById("form-container");
      const petDiv = document.createElement("div");
      petDiv.classList.add("pet-card");
      petDiv.id = `pet_${contadorPets}`;

      const temBotaoRemover = contadorPets > 1
        ? `<button type="button" class="remove-pet-btn" onclick="removerPet(${contadorPets})" title="Remover este pet">‚úï</button>`
        : "";

      petDiv.innerHTML = `
        <div class="pet-header">
          <h4 style="text-align:center;color:#e2725b;margin:0;">üê∂ Pet ${contadorPets}</h4>
          ${temBotaoRemover}
        </div>

        <label>Nome do Pet:</label>
        <input type="text" name="nome_pet_${contadorPets}" required placeholder="Ex: Thor">

        <label>Esp√©cie:</label>
        <select name="especie_pet_${contadorPets}" required onchange="mostrarOutro(this, ${contadorPets})">
          <option value="">Selecione</option>
          <option value="Cachorro">Cachorro</option>
          <option value="Gato">Gato</option>
          <option value="P√°ssaro">P√°ssaro</option>
          <option value="Roedor">Roedor</option>
          <option value="R√©ptil">R√©ptil</option>
          <option value="Outro">Outro</option>
        </select>

        <input type="text" id="outro_${contadorPets}" name="outro_especie_${contadorPets}" placeholder="Especifique a esp√©cie" style="display:none;">

        <label>Ra√ßa:</label>
        <input type="text" name="raca_pet_${contadorPets}" placeholder="Ex: Poodle, Siam√™s...">

        <div class="radio-group">
          <label>Sexo:</label>
          <label><input type="radio" name="sexo_pet_${contadorPets}" value="Macho" required> Macho</label>
          <label><input type="radio" name="sexo_pet_${contadorPets}" value="F√™mea"> F√™mea</label>
        </div>

        <label>Idade (anos):</label>
        <input type="number" name="idade_pet_${contadorPets}" min="0" max="40" required placeholder="Ex: 3">

        <label>Porte:</label>
        <select name="porte_pet_${contadorPets}" required>
          <option value="">Selecione</option>
          <option value="Pequeno">Pequeno</option>
          <option value="M√©dio">M√©dio</option>
          <option value="Grande">Grande</option>
        </select>

        <label>Observa√ß√µes:</label>
        <textarea name="obs_pet_${contadorPets}" placeholder="Ex: Toma rem√©dio, √© soci√°vel, etc."></textarea>

        <label>Foto do Pet:</label>
        <input type="file" name="foto_pet_${contadorPets}" accept="image/*" onchange="previewImagem(event, ${contadorPets})">
        <div class="preview"><img id="preview_${contadorPets}" alt="Preview do pet"></div>
      `;
      container.appendChild(petDiv);
    }

    function mostrarOutro(select, id){
      const outro = document.getElementById(`outro_${id}`);
      outro.style.display = select.value === "Outro" ? "block" : "none";
    }

    function previewImagem(event, id){
      const preview = document.getElementById(`preview_${id}`);
      const arquivo = event.target.files[0];
      if(arquivo){
        const leitor = new FileReader();
        leitor.onload = () => { preview.src = leitor.result; preview.style.display = "block"; };
        leitor.readAsDataURL(arquivo);
      }else{
        preview.style.display = "none";
      }
    }

    function removerPet(id){
      const petCard = document.getElementById(`pet_${id}`);
      petCard.classList.add("fade-out");
      setTimeout(() => petCard.remove(), 300);
    }

    document.addEventListener("submit", (e) => {
      if(e.target.id === "formPets"){
        const cards = document.querySelectorAll(".pet-card");
        if (cards.length === 0){ e.preventDefault(); alert("Adicione pelo menos 1 pet."); }
      }
    });
  </script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
    const BUCKET = "pets";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Guarda de sess√£o: se n√£o logada, manda para login com next
    async function requireAuth(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        window.location.href = "cadastrarouentrar.html?next=cadastroPets.html";
        return null;
      }
      return user;
    }

    function slugify(str){
      return String(str||"")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toLowerCase().replace(/[^a-z0-9]+/g,"-")
        .replace(/(^-|-$)+/g,"");
    }

    async function uploadFoto(userId, idx, file){
      if(!file) return null;
      const ext  = (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `${userId}/${Date.now()}_pet${idx}.${ext}`;
      const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, { upsert:false });
      if(upErr) throw upErr;
      const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
      return pub?.publicUrl || null;
    }

    function lerPetDoCard(card, idx){
      const nome   = card.querySelector(`[name="nome_pet_${idx}"]`)?.value?.trim();
      const especieSel = card.querySelector(`[name="especie_pet_${idx}"]`)?.value;
      const especieOut = card.querySelector(`[name="outro_especie_${idx}"]`)?.value?.trim();
      const raca   = card.querySelector(`[name="raca_pet_${idx}"]`)?.value?.trim() || null;
      const sexo   = card.querySelector(`[name="sexo_pet_${idx}"]:checked`)?.value || null;
      const idade  = card.querySelector(`[name="idade_pet_${idx}"]`)?.value || null;
      const porte  = card.querySelector(`[name="porte_pet_${idx}"]`)?.value || null;
      const obs    = card.querySelector(`[name="obs_pet_${idx}"]`)?.value?.trim() || null;
      const file   = card.querySelector(`[name="foto_pet_${idx}"]`)?.files?.[0] || null;
      const especie = (especieSel === "Outro" && especieOut) ? especieOut : especieSel;
      return { nome, especie, raca, sexo, idade: idade?Number(idade):null, porte, obs, file };
    }

    // Inicializa√ß√£o com guarda de sess√£o
    document.addEventListener("DOMContentLoaded", async ()=>{
      const user = await requireAuth();
      if(!user) return;
      // S√≥ cria o primeiro card depois de logada
      adicionarPet();

      // Bot√£o de add outro pet
      document.getElementById("btnAdd").addEventListener("click", adicionarPet);

      // Submit
      document.getElementById("formPets").addEventListener("submit", async (e)=>{
        e.preventDefault();

        const cards = Array.from(document.querySelectorAll(".pet-card"));
        if(cards.length === 0){ alert("Adicione pelo menos 1 pet."); return; }

        const btn = document.getElementById("salvar");
        btn.disabled = true; btn.textContent = "Salvando‚Ä¶";

        try{
          let total = 0;
          for(let i=0;i<cards.length;i++){
            const idx = i+1;
            const pet = lerPetDoCard(cards[i], idx);

            if(!pet.nome || !pet.especie || !pet.sexo || !pet.idade || !pet.porte){
              throw new Error(`Preencha todos os campos obrigat√≥rios do Pet ${idx}.`);
            }

            const photo_url = await uploadFoto(user.id, idx, pet.file);

            const payload = {
              owner_id: user.id,
              name: pet.nome,
              species: pet.especie,
              breed: pet.raca,
              sex: pet.sexo,
              size: pet.porte,
              special_needs: pet.obs,
              photo_url,
              birthdate: null,
              weight_kg: null,
              vaccinated: false,
              neutered: false,
              temperament: null
            };

            const { error: insErr } = await sb.from("pets").insert(payload);
            if(insErr) throw insErr;
            total++;
          }

          alert(`‚úî ${total} pet(s) cadastrados com sucesso!`);
          window.location.href = "meusPets.php";
        }catch(err){
          console.error(err);
          alert("Falha ao salvar pets: " + (err?.message || err));
        }finally{
          btn.disabled = false; btn.textContent = "Salvar Pets";
        }
      });
    });
  </script>
</body>
</html>
