<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alterar Senha ‚Äî Patas Pousada</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Parkinsans:wght@400;700&display=swap');

    :root{
      --pp-primary:#e2725b;
      --pp-primary-600:#d65a47;
      --pp-primary-100:#fff4f3;
      --pp-danger:#b91c1c;
      --pp-ok:#0f766e;
      --pp-gray:#6b7280;
      --pp-border:#e5e7eb;
      --pp-bg:#fafafa;
      --pp-text:#111827;
    }

    *{box-sizing:border-box}
    body{font-family:'Nunito',Arial,sans-serif;background:var(--pp-bg);color:var(--pp-text);margin:0}

    header{display:flex;justify-content:center;background:#fff;padding:16px 0;box-shadow:0 2px 4px rgba(0,0,0,.07)}
    nav{display:flex;justify-content:space-between;align-items:center;max-width:1200px;width:100%;padding:0 20px}
    nav .logo{font-size:1.5rem;font-weight:800;color:var(--pp-primary);text-decoration:none;font-family:'Parkinsans',sans-serif}
    nav img{width:30px;height:30px}
    nav ul{list-style:none;display:flex;gap:16px;margin:0;padding:0}
    nav ul a{font-weight:700;color:#333;text-decoration:none;font-family:'Parkinsans',sans-serif}
    nav ul a:hover{color:var(--pp-primary-600)}

    .wrap{max-width:760px;margin:36px auto;padding:0 16px}
    .card{
      background:#fff;border:1px solid var(--pp-border);border-radius:18px;
      box-shadow:0 6px 20px rgba(0,0,0,.06);overflow:hidden;
    }
    .card header{box-shadow:none;background:linear-gradient(180deg,#fff, #fff)}
    .card .body{padding:22px}
    h1{margin:0;color:var(--pp-primary);font-family:'Parkinsans',sans-serif;font-size:1.6rem}

    label{display:block;font-size:.92rem;margin:12px 0 6px;color:#374151}
    .field{position:relative;}
    .field input{
      width:100%;padding:12px 44px 12px 12px;border:1px solid #e87a7e;border-radius:12px;
      background:#fee9e8;color:#111;outline:none;transition:border .15s;
    }
    .field input:focus{border-color:var(--pp-primary)}
    .toggle-eye{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
      border:none;background:transparent;cursor:pointer;font-size:.95rem;opacity:.7;
    }
    .toggle-eye:hover{opacity:1}

    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:720px){ .row-2{grid-template-columns:1fr 1fr} }

    .help{font-size:.85rem;color:var(--pp-gray);margin-top:6px}

    .strength{
      margin-top:8px;background:#f3f4f6;height:8px;border-radius:999px;overflow:hidden;border:1px solid var(--pp-border)
    }
    .strength > span{display:block;height:100%;width:0%;background:var(--pp-danger);transition:width .2s, background .2s}

    .reqs{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;margin-top:10px}
    .reqs .ok{color:var(--pp-ok)}
    .reqs .nok{color:#9ca3af}
    .reqs span{font-size:.86rem}

    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:18px}
    .btn{
      border-radius:12px;padding:10px 16px;font-weight:800;border:2px solid transparent;cursor:pointer
    }
    .btn-primary{background:var(--pp-primary);color:#fff;border-color:var(--pp-primary)}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#fff;border:2px solid var(--pp-primary);color:var(--pp-primary)}
    .btn-link{background:transparent;border:none;color:#0b69c7;cursor:pointer}

    .msg{margin-top:10px;font-size:.92rem;min-height:1.2em}
    .msg.ok{color:var(--pp-ok)}
    .msg.err{color:var(--pp-danger)}

    footer{text-align:center;color:#8b8b8b;margin:40px 0 20px;font-size:.9rem}

    /* ===== TOASTS VISUAIS ===== */
    .toast{
      position:fixed;top:50%;left:50%;
      transform:translate(-50%,-50%) scale(.9);
      background:#fff;
      border-radius:20px;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
      padding:28px 32px;
      max-width:420px;width:90%;
      color:#111;text-align:center;font-family:'Nunito',sans-serif;
      z-index:2000;display:none;opacity:0;
      transition:opacity .3s ease, transform .3s ease;
      border:3px solid var(--pp-primary);
    }
    .toast.show{display:block;opacity:1;transform:translate(-50%,-50%) scale(1);}
    .toast .icon{font-size:2.5rem;margin-bottom:6px}
    .toast h3{margin:10px 0 8px;font-family:'Parkinsans',sans-serif;font-size:1.3rem}
    .toast p{margin:0;font-size:.95rem;color:#444}
    .toast button{
      margin-top:18px;padding:8px 18px;background:var(--pp-primary);border:none;
      border-radius:12px;color:#fff;font-weight:700;cursor:pointer;transition:.2s;
    }
    .toast button:hover{background:var(--pp-primary-600)}
    .toast.success{border-color:var(--pp-ok)}
    .toast.success .icon{color:var(--pp-ok)}
    .toast.success button{background:var(--pp-ok)}
  </style>
</head>
<body>
  <header>
    <nav>
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="Icone">
      <a href="index.html" class="logo">Patas Pousada</a>
      <ul>
        <li><a href="reservas.html">Reservas</a></li>
        <li><a href="ajuda.html">Ajuda</a></li>
      </ul>
    </nav>
  </header>

  <div class="wrap">
    <div class="card">
      <header style="padding:18px 22px">
        <h1>Altere sua senha</h1>
      </header>
      <div class="body">
        <form id="formSenha">
          <div class="row row-2">
            <div>
              <label for="senha-atual">Senha atual</label>
              <div class="field">
                <input type="password" id="senha-atual" autocomplete="current-password" placeholder="Digite sua senha atual" required>
                <button class="toggle-eye" type="button" data-target="senha-atual">üëÅÔ∏è</button>
              </div>
              <div class="help"><button id="btn-esqueci" type="button" class="btn-link">Esqueceu sua senha?</button></div>
            </div>

            <div>
              <label for="nova-senha">Nova senha</label>
              <div class="field">
                <input type="password" id="nova-senha" autocomplete="new-password" placeholder="Crie uma nova senha" required>
                <button class="toggle-eye" type="button" data-target="nova-senha">üëÅÔ∏è</button>
              </div>
              <div class="strength"><span id="bar"></span></div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="confirmar-senha">Confirmar nova senha</label>
              <div class="field">
                <input type="password" id="confirmar-senha" autocomplete="new-password" placeholder="Repita a nova senha" required>
                <button class="toggle-eye" type="button" data-target="confirmar-senha">üëÅÔ∏è</button>
              </div>
            </div>
          </div>

          <div class="reqs" id="reqs">
            <span id="r-len"   class="nok">‚Ä¢ M√≠nimo de 8 caracteres</span>
            <span id="r-case"  class="nok">‚Ä¢ Mai√∫scula e min√∫scula</span>
            <span id="r-num"   class="nok">‚Ä¢ Pelo menos 1 n√∫mero</span>
            <span id="r-spec"  class="nok">‚Ä¢ Pelo menos 1 s√≠mbolo (!@#$‚Ä¶)</span>
          </div>

          <div class="actions">
            <a class="btn btn-secondary" href="home_tutor.html">Cancelar</a>
            <button class="btn btn-primary" id="btn-salvar" type="submit" disabled>Salvar</button>
          </div>

          <div class="msg" id="msg"></div>
        </form>
      </div>
    </div>
  </div>

  <footer>¬© 2025 Patas Pousada ‚Ä¢ Todos os direitos reservados</footer>

  <!-- Toast visual -->
  <div class="toast" id="toast">
    <div class="icon">üì®</div>
    <h3>Verifique seu e-mail!</h3>
    <p id="toastMsg">Enviamos um link para redefinir sua senha.</p>
    <button id="toastClose">OK</button>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const f = document.getElementById('formSenha');
    const btnSalvar = document.getElementById('btn-salvar');
    const msg = document.getElementById('msg');

    // ===== TOASTS =====
    function toast(message, title="Verifique seu e-mail!", type="alert"){
      const t=document.getElementById('toast');
      const msgEl=document.getElementById('toastMsg');
      const icon=t.querySelector('.icon');
      t.className='toast '+(type==='success'?'success':'');
      msgEl.textContent=message;
      t.querySelector('h3').textContent=title;
      icon.textContent= type==='success' ? '‚úÖ' : 'üì®';
      t.style.display='block';
      requestAnimationFrame(()=>t.classList.add('show'));
      const closeBtn=document.getElementById('toastClose');
      closeBtn.onclick=()=>{t.classList.remove('show');setTimeout(()=>t.style.display='none',300);}
      setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.style.display='none',300);}, 6000);
    }

    // Mostrar/ocultar senha
    document.querySelectorAll('.toggle-eye').forEach(b=>{
      b.addEventListener('click', ()=>{
        const input = document.getElementById(b.dataset.target);
        input.type = (input.type === 'password') ? 'text' : 'password';
      });
    });

    // Valida√ß√£o e for√ßa
    const inputNova = document.getElementById('nova-senha');
    const inputConf = document.getElementById('confirmar-senha');
    const bar = document.getElementById('bar');

    function checkReqs(s){
      const r = {
        len: s.length >= 8,
        case: /[a-z]/.test(s) && /[A-Z]/.test(s),
        num: /\d/.test(s),
        spec: /[^A-Za-z0-9]/.test(s)
      };
      document.getElementById('r-len' ).className = r.len  ? 'ok' : 'nok';
      document.getElementById('r-case').className = r.case ? 'ok' : 'nok';
      document.getElementById('r-num' ).className = r.num  ? 'ok' : 'nok';
      document.getElementById('r-spec').className = r.spec ? 'ok' : 'nok';

      const score = Object.values(r).filter(Boolean).length;
      bar.style.width = (score*25)+'%';
      bar.style.background = score<=1 ? '#ef4444' : score===2 ? '#f59e0b' : score===3 ? '#22c55e' : '#0ea5e9';
      return r;
    }

    function updateButton(){
      const s1 = inputNova.value, s2 = inputConf.value;
      const ok = Object.values(checkReqs(s1)).every(Boolean) && s1 === s2;
      btnSalvar.disabled = !ok;
      msg.className = 'msg ' + (s1 && s2 ? (s1===s2 ? 'ok' : 'err') : '');
      msg.textContent = s1 && s2 ? (s1===s2 ? 'Senhas iguais.' : 'As senhas n√£o coincidem.') : '';
    }
    inputNova.addEventListener('input', updateButton);
    inputConf.addEventListener('input', updateButton);

    // Esqueci a senha
    document.getElementById('btn-esqueci').addEventListener('click', async ()=>{
      const { data: { user } } = await sb.auth.getUser();
      if(!user){ window.location.href = "cadastrarouentrar.html?next=alterarSenha.html"; return; }
      try{
        const { error } = await sb.auth.resetPasswordForEmail(user.email, {
          redirectTo: window.location.origin + '/cadastrarouentrar.html'
        });
        if(error) throw error;
        toast('Enviamos um link de redefini√ß√£o para o seu e-mail.', 'Verifique seu e-mail!', 'alert');
      }catch(err){ toast('Erro: '+err.message, 'Falha no envio', 'alert'); }
    });

    // Alterar senha
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      btnSalvar.disabled = true; btnSalvar.textContent = 'Salvando‚Ä¶'; msg.textContent = '';

      const atual = document.getElementById('senha-atual').value;
      const nova  = document.getElementById('nova-senha').value;

      try{
        const { data: { user } } = await sb.auth.getUser();
        if(!user){ window.location.href = "cadastrarouentrar.html?next=alterarSenha.html"; return; }

        const { error: reauthErr } = await sb.auth.signInWithPassword({ email: user.email, password: atual });
        if(reauthErr){ throw new Error('Senha atual incorreta.'); }

        const { error: updErr } = await sb.auth.updateUser({ password: nova });
        if(updErr){ throw updErr; }

        toast('Sua senha foi alterada com sucesso!', 'Sucesso!', 'success');
        await sb.auth.signOut();
        setTimeout(()=>{ window.location.href = "cadastrarouentrar.html?next=home_tutor.html"; }, 1800);

      }catch(err){
        msg.className = 'msg err';
        msg.textContent = err.message || 'Falha ao alterar a senha.';
        btnSalvar.disabled = false; btnSalvar.textContent = 'Salvar';
      }
    });

    (async function guard(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user){ window.location.href = "cadastrarouentrar.html?next=alterarSenha.html"; }
    })();
  </script>
</body>
</html>
