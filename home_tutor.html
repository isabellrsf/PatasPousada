<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>√Årea do Tutor ‚Äî Patas Pousada</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');

  :root{
    --brand:#e2725b; --brand-strong:#d45f47; --ink:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --white:#fff;
    --radius:12px; --shadow:0 2px 8px rgba(0,0,0,.04); --line:#e5e7eb;
    --chip:#fff0ec; --chip-border:#ffd8cf;
    --transition: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Nunito,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink); line-height: 1.5; -webkit-font-smoothing: antialiased;}
  a{color:inherit; text-decoration: none;}

  /* Header */
  header{display:flex;justify-content:center;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px); background: rgba(255,255,255,0.95);}
  nav{max-width:1100px;width:100%;padding:16px 24px;display:flex;align-items:center;gap:20px; justify-content: space-between;}
  
  .logo{display:flex;align-items:center;gap:10px; color:var(--brand);font-family:Parkinsans,sans-serif;font-weight:800; font-size: 1.35rem;}
  .logo img{width:34px;height:34px;}
  
  nav ul{list-style:none;display:flex;gap:24px;margin:0;padding:0; align-items: center;}
  nav ul a{font-family:Parkinsans,sans-serif;font-weight:600;color:#4b5563; font-size: 1rem; transition: color var(--transition);}
  nav ul a:hover{color:var(--brand)}
  .pill{color:var(--brand); background: var(--chip); padding: 6px 14px; border-radius: 20px; font-size: 0.9rem;}
  .pill:hover{background: #ffe4de;}

  /* User Menu */
  .user-menu{position:relative;}
  .user-trigger{display:flex;align-items:center;gap:10px;cursor:pointer; padding: 6px 12px 6px 6px; border-radius: 40px; transition: background var(--transition); border: 1px solid transparent;}
  .user-trigger:hover { background: #fff; border-color: var(--line); box-shadow: var(--shadow); }
  
  .user-avatar-img {
      width: 40px; height: 40px; border-radius: 50%;
      object-fit: cover; border: 1px solid #fff; background: #eee;
      display: none; 
  }
  .user-initials-badge {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--chip); color: var(--brand);
      border: 1px solid var(--chip-border);
      display: grid; place-items: center;
      font-weight: 800; font-size: 1.1rem;
      display: none; 
  }

  .user-trigger strong { font-size: 1rem; color: #374151; }
  .user-trigger svg{width:12px;height:12px;fill:#9ca3af;transition:transform .2s}
  .user-menu:hover .user-trigger svg{transform:rotate(180deg)}
  
  .dropdown{position:absolute;top:calc(100% + 8px);right:0;background:#fff;border-radius:12px;box-shadow: 0 10px 25px rgba(0,0,0,0.1); width:220px;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s;z-index:30; overflow: hidden; border: 1px solid var(--line);}
  .user-menu:hover .dropdown{opacity:1;visibility:visible;transform:translateY(0)}
  .dropdown a{display:flex;align-items: center; gap:10px;padding:10px 16px;color:#4b5563;font-weight:600; font-size: 0.85rem; transition: background var(--transition);}
  .dropdown a:hover{background:#f9fafb; color: var(--brand);}
  .dropdown i { width: 16px; text-align: center; }

  /* Container */
  .wrap{max-width:1100px;margin:24px auto;padding:0 24px}

  .hello-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .hello{color:#1f2937; font-size: 1.35rem; font-family: Parkinsans, sans-serif; font-weight: 700;}
  .hello strong{color:var(--brand)}

  .mini-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom: 32px;}
  .mini-card{
    display:flex;align-items:center;gap:12px;background:#fff;border-radius:12px;padding:16px;
    box-shadow:var(--shadow);text-decoration:none;transition:transform .2s, box-shadow .2s; border: 1px solid transparent;
  }
  .mini-card:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,.06); border-color: var(--chip-border);}
  .mini-icon{width:40px;height:40px;border-radius:10px;background:var(--chip);display:grid;place-items:center;color:var(--brand); font-size: 1.1rem;}
  .mini-text b{display:block;font-weight:700; font-size: 0.95rem; margin-bottom: 1px;}
  .mini-text small{color:#6b7280; font-size: 0.8rem;}

  .cols{display:grid;grid-template-columns:260px 1fr 280px;gap:24px}
  @media (max-width:1024px){ .cols{grid-template-columns:1fr 280px;} .sidebar-left { display: none; } }
  @media (max-width:850px){ .cols{grid-template-columns:1fr} .sidebar-right { display: none; } }

  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow); overflow: hidden; border: 1px solid rgba(0,0,0,0.02);}
  .card .hd{padding:14px 18px;border-bottom:1px solid var(--line);font-weight:700;color:#111; font-family: Parkinsans, sans-serif; display: flex; align-items: center; justify-content: space-between; font-size: 0.95rem;}
  
  .filters{padding:16px;display:flex;flex-direction:column;gap:10px}
  .chip-btn{
    display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;color:#4b5563;background:#fff;border-radius:8px;
    padding:8px 12px;font-weight:600;cursor:pointer;transition:all .2s;text-decoration:none; font-size: 0.85rem; width: 100%;
  }
  .chip-btn:hover{background:#f9fafb; border-color: #d1d5db;}
  .chip-btn.active{background:var(--chip);color:var(--brand); border-color: var(--chip-border);}
  .select{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px; font-family: Nunito, sans-serif; color: #374151; outline: none; transition: border-color 0.2s; font-size: 0.9rem;}
  .select:focus { border-color: var(--brand); }

  .feed{display:flex;flex-direction:column;gap:16px}
  
  /* === CARD DO HOST AINDA MENOR === */
  .host{
    background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden;display:grid;
    grid-template-columns: 120px 1fr 115px;
    transition: transform 0.2s, border-color 0.2s; border: 1px solid transparent;
    min-height: 100px;
  }
  .host:hover { transform: translateY(-2px); border-color: var(--chip-border); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }

  /* Galeria de fotos com scroll */
  .host .photo-container{
    height:100px; background:#f3f4f6; position: relative; overflow: hidden;
  }
  .photo-scroll {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    height: 100%;
    width: 100%;
    scrollbar-width: none;
  }
  .photo-scroll::-webkit-scrollbar { display: none; }

  .photo-scroll img{
    flex-shrink: 0;
    min-width: 100%;
    height:100%;
    object-fit:cover; 
    scroll-snap-align: center;
  }
  
  .photo-badge {
    position: absolute; bottom: 4px; right: 4px;
    background: rgba(0,0,0,0.6); color: #fff;
    font-size: 0.65rem; padding: 2px 6px; border-radius: 10px;
    font-weight: 600; pointer-events: none;
  }

  .host .body{padding:8px 10px; display: flex; flex-direction: column; justify-content: center;}
  .host .body h3{margin:0 0 2px; font:700 0.9rem Parkinsans,sans-serif; color:#111; display: flex; align-items: center; gap: 6px;}
  .host .body h3 span { font-size: 0.75rem; color: #6b7280; font-weight: 400; font-family: Nunito, sans-serif; }
  
  .meta{display:flex;flex-wrap:wrap;gap:4px;color:#4b5563;font-size:0.7rem; margin-top: 2px;}
  .meta .tag{display:inline-flex;align-items:center;gap:4px;background:#f3f4f6;border-radius:4px;padding:2px 6px; font-weight: 600; color: #555;}
  .rating{color:#f59e0b;font-weight:700; display: flex; align-items: center; gap: 3px;}
  
  .meta-details {
    margin-top: 4px;
    font-size: 0.7rem;
    color: #6b7280;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .meta-details div { display: flex; align-items: center; gap: 6px; }
  .meta-details i { color: #9ca3af; width: 12px; text-align: center;}

  .about-text { margin-top: 4px; font-size: 0.74rem; color: #6b7280; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  .host .cta{
    border-left:1px solid var(--line);display:flex;flex-direction:column;justify-content:center;align-items:center;padding:8px;gap:6px; background: #fafafa;
  }
  .price{font-weight:800; font-size: 0.9rem; color: var(--brand);}
  .price small { font-size: 0.7rem; color: #6b7280; font-weight: 400; }
  
  .btn{
    all:unset;display:inline-block;background:#fff;color:var(--brand);border:1px solid var(--brand);
    padding:4px 10px; border-radius:20px;font-weight:700;cursor:pointer;text-align:center; font-size: 0.72rem; transition: all 0.2s;
  }
  .btn:hover{background:var(--brand);color:#fff;}
  
  .empty{padding:40px;text-align:center;color:#6b7280; font-size: 0.95rem;}

  .help{padding:18px}
  .help h4{margin:0 0 6px;font-weight:700; color: #111; font-size: 0.95rem;}
  .help p{margin:0 0 10px;color:#4b5563; font-size: 0.85rem; line-height: 1.4;}
  .help a{color:var(--brand);font-weight:700;font-size: 0.85rem;}
  .help a:hover { text-decoration: underline; }

  /* Modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:50; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.2s;}
  .modal.show{display:grid; opacity: 1;}
  .modal .box{background:#fff;border-radius:20px;max-width:500px;width:92%;box-shadow:0 20px 50px rgba(0,0,0,0.2);overflow:hidden; transform: translateY(20px); transition: transform 0.2s;}
  .modal.show .box { transform: translateY(0); }
  
  .box .box-hd{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--line); background: #fff;}
  .box .box-hd h3{margin:0;font:700 1.2rem Parkinsans,sans-serif;}
  .box .box-bd{padding:24px;}
  .x{cursor:pointer;border:none;background:transparent;font-size:24px; color: #9ca3af; transition: color 0.2s;}
  .x:hover { color: #111; }

  /* Modal Delete */
  .pp-wrap{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60; backdrop-filter: blur(4px);}
  .pp-card{width:min(420px,92vw);background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.3);overflow:hidden;transform:scale(0.95);opacity:0;transition:all 0.2s;}
  .pp-card.show{transform:scale(1);opacity:1;}
  .pp-card header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid #fee2e2;background:#fff5f5;}
  .pp-card header .ic{width:24px;height:24px;display:grid;place-items:center;border-radius:50%;background:#fee2e2;color:#b91c1c;font-weight:900; font-size: 0.9rem;}
  .pp-card h4{margin:0;font-weight:700;color:#991b1b; font-size: 1.1rem;}
  .pp-body{padding:20px;font-size:.95rem;color:#374151;}
  .pp-body p{margin:0 0 12px;}
  .pp-body input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-family:'Nunito',sans-serif;font-size:.95rem; margin-top: 8px;}
  .pp-ft{display:flex;gap:12px;justify-content:flex-end;padding:16px 20px;background:#f9fafb;border-top:1px solid #f3f4f6;}
  .pp-btn{border-radius:8px;padding:10px 16px;font-weight:700;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-size:.9rem; transition: all 0.2s;}
  .pp-btn:hover{background:#f3f4f6;}
  .pp-ok{background:#dc2626;color:#fff;border-color:#dc2626;}
  .pp-ok:hover{background:#b91c1c;}

  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:12px 24px;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,.2);font-size:.9rem;display:none;z-index:70; font-weight: 600;}

  @media (max-width: 600px) {
      .host { grid-template-columns: 1fr; min-height: auto; }
      .host .photo-container { height: 160px; }
      .host .cta { border-left: none; border-top: 1px solid var(--line); flex-direction: row; justify-content: space-between; background: #fff; padding: 10px 14px; }
      .nav-links { display: none; }
      header { padding: 0 16px; }
      .hello-section { flex-direction: column; align-items: flex-start; gap: 10px; }
      .host .body h3 { font-size: 1rem; }
      .about-text { -webkit-line-clamp: 3; }
  }

  /* Chat Widget CSS (mantido) */
  .pp-chat-fab { position: fixed; right: 25px; bottom: 25px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-strong)); color: #fff; display: grid; place-items: center; cursor: pointer; box-shadow: 0 8px 24px rgba(226,114,91,0.4); z-index: 120; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  .pp-chat-fab:hover { transform: scale(1.1) rotate(-5deg); box-shadow: 0 12px 28px rgba(226,114,91,0.6); }
  .pp-chat-fab i { font-size: 1.6rem; }
  .pp-badge { position: absolute; top: 0; right: 0; width: 20px; height: 20px; background: #dc2626; color: #fff; border-radius: 50%; font-size: 0.7rem; display: none; place-items: center; justify-content: center; border: 2px solid #fff; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.2); animation: pulseBadge 2s infinite; }
  .pp-badge.show { display: flex; }
  @keyframes pulseBadge { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  .pp-chat-widget { position: fixed; right: 25px; bottom: 100px; width: 420px; max-height: 600px; background: #fff; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.03); display: none; flex-direction: column; overflow: hidden; z-index: 130; font-family: 'Nunito', sans-serif; animation: chatSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  @keyframes chatSlideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
  .pp-chat-header { padding: 16px 20px; background: linear-gradient(135deg, var(--brand), var(--brand-strong)); color: #fff; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(212, 95, 71, 0.2); z-index: 2; }
  .pp-chat-header strong { font-family: 'Parkinsans', sans-serif; font-size: 1.1rem; line-height: 1.2; letter-spacing: -0.5px; color: #fff; }
  #ppChatSubtitle { display: block; font-size: 0.8rem; color: rgba(255,255,255,0.85); margin-top: 2px; font-weight: 400; }
  .pp-chat-close { border: none; background: rgba(255,255,255,0.2); width: 32px; height: 32px; border-radius: 50%; font-size: 0.9rem; cursor: pointer; color: #fff; display: grid; place-items: center; transition: background 0.2s; }
  .pp-chat-close:hover { background: rgba(255,255,255,0.35); }
  .pp-chat-body { display: grid; grid-template-columns: 140px 1fr; height: 450px; overflow: hidden; background: #fff; }
  .pp-chat-conversations { background: #f8f9fa; border-right: 1px solid #e5e7eb; overflow-y: auto; padding: 8px; scrollbar-width: thin; }
  .pp-chat-conversations::-webkit-scrollbar, .pp-chat-messages::-webkit-scrollbar { width: 8px; }
  .pp-chat-conversations::-webkit-scrollbar-track, .pp-chat-messages::-webkit-scrollbar-track { background: transparent; }
  .pp-chat-conversations::-webkit-scrollbar-thumb, .pp-chat-messages::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 10px; border: 2px solid #fff; }
  .pp-chat-conv-item { border-radius: 10px; padding: 12px 10px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; transition: all 0.2s; border-left: 3px solid transparent; margin-bottom: 4px; position: relative; padding-right: 26px; }
  .pp-chat-conv-item:hover { background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .pp-chat-conv-item.active { background: #fff; border-left-color: var(--brand); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
  .pp-chat-conv-name { font-size: 0.85rem; font-weight: 700; color: #374151; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .pp-chat-conv-role { font-size: 0.65rem; color: var(--brand); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .pp-chat-conv-meta { font-size: 0.7rem; color: #9ca3af; }

  /* bot√£o de excluir chat */
  .pp-chat-delete{
    position:absolute;
    top:6px;
    right:6px;
    width:18px;
    height:18px;
    border-radius:50%;
    border:none;
    background:transparent;
    color:#9ca3af;
    display:grid;
    place-items:center;
    font-size:0.6rem;
    cursor:pointer;
    transition:background .15s,color .15s;
  }
  .pp-chat-conv-item:hover .pp-chat-delete{ color:#6b7280; }
  .pp-chat-delete:hover{
    background:#fee2e2;
    color:#b91c1c;
  }

  .pp-chat-thread { display: flex; flex-direction: column; height: 100%; position: relative; background-color: #fff9f8; background-image: radial-gradient(rgba(226, 114, 91, 0.15) 1px, transparent 1px); background-size: 20px 20px; overflow: hidden; }
  .pp-chat-messages { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; min-height: 0; }
  .pp-chat-messages::-webkit-scrollbar-thumb { border: 2px solid #fff9f8; }
  .pp-chat-messages:empty::before { content: "üëã Selecione ou inicie uma conversa"; display: flex; height: 100%; align-items: center; justify-content: center; color: #9ca3af; font-size: 0.9rem; font-weight: 600; text-align: center; }
  .pp-chat-msg-row { display: flex; width: 100%; animation: fadeInMsg 0.2s ease-out; }
  @keyframes fadeInMsg { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
  .pp-chat-msg-row.me { justify-content: flex-end; }
  .pp-chat-bubble { max-width: 80%; padding: 10px 14px; font-size: 0.9rem; line-height: 1.45; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.08); }
  .pp-chat-bubble.me { background: linear-gradient(135deg, var(--brand), var(--brand-strong)); color: #fff; border-radius: 16px 16px 2px 16px; }
  .pp-chat-bubble.other { background: #fff; color: #1f2937; border: 1px solid #eee; border-radius: 16px 16px 16px 2px; }
  .pp-chat-time { font-size: 0.65rem; margin-top: 4px; text-align: right; opacity: 0.8; font-weight: 500; }
  .pp-chat-bubble.other .pp-chat-time { color: #9ca3af; }
  .pp-chat-input-area { display: flex; padding: 12px; gap: 10px; border-top: 1px solid #e5e7eb; background: #fff; flex-shrink: 0; }
  .pp-chat-input-area input { flex: 1; border-radius: 24px; border: 1px solid #e5e7eb; padding: 10px 16px; font-size: 0.9rem; outline: none; font-family: 'Nunito', sans-serif; background: #f9fafb; transition: all 0.2s; }
  .pp-chat-input-area input:focus { background: #fff; border-color: var(--brand); box-shadow: 0 0 0 4px rgba(226,114,91,0.1); }
  .pp-chat-input-area button { width: 42px; height: 42px; border-radius: 50%; border: none; background: var(--brand); color: #fff; cursor: pointer; display: grid; place-items: center; transition: all 0.2s; flex-shrink: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .pp-chat-input-area button:hover { background: var(--brand-strong); transform: scale(1.05); box-shadow: 0 4px 10px rgba(226,114,91,0.3); }
  @media (max-width: 600px) { .pp-chat-widget { right: 0; left: 0; bottom: 0; width: 100%; height: 100dvh; max-height: none; border-radius: 0; } .pp-chat-body { grid-template-columns: 1fr; height: calc(100% - 65px); } .pp-chat-conversations { display: none; } .pp-chat-fab { bottom: 20px; right: 20px; } }

  /* Footer */
  footer { margin-top: 32px; background: #fff; border-top: 1px solid var(--line); }
  .footer-inner { max-width: 1100px; margin: 0 auto; padding: 14px 24px 18px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 0.85rem; color: #6b7280; }
  .footer-links { display: flex; gap: 16px; flex-wrap: wrap; }
  .footer-links a { color: #6b7280; text-decoration: none; font-weight: 500; }
  .footer-links a:hover { text-decoration: underline; color: var(--brand); }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <nav>
    <a href="index.html" class="logo">
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="">
      <span>Patas Pousada</span>
    </a>

    <ul>
      <li><a href="#">Reservas</a></li>
      <li><a href="ajuda.html">Ajuda</a></li>
      <li><a class="pill" href="#">Lar Tempor√°rio</a></li>
      
      <li class="user-menu">
        <div class="user-trigger">
          <img id="userAvatar" class="user-avatar-img" src="" alt="Foto">
          <div id="userInitial" class="user-initials-badge">U</div>
          
          <strong id="userName">Usu√°rio</strong>
          <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5H7z"></path></svg>
        </div>
        <div class="dropdown">
          <a href="menu_perfil.html"><i class="fa-solid fa-user-pen"></i> Editar perfil</a>
          <a href="meusPets.html"><i class="fa-solid fa-paw"></i> Meus pets</a>
          <a href="#" id="logoutLink"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</a>
          <div style="height:1px;background:#f3f4f6;margin:4px 0"></div>
          <a href="#" id="deleteAccountLink" style="color:#dc2626;">
            <i class="fa-solid fa-user-xmark"></i> Excluir conta
          </a>
        </div>
      </li>
    </ul>
  </nav>
</header>

<div class="wrap">
  <div class="hello-section">
      <div class="hello">Ol√°, <strong id="helloName">Tutor</strong>! üëã</div>
  </div>

  <div class="mini-grid">
    <a class="mini-card" href="menu_perfil.html">
      <div class="mini-icon"><i class="fa-regular fa-id-card"></i></div>
      <div class="mini-text"><b>Dados pessoais</b><small>Atualize seu cadastro</small></div>
    </a>
    <a class="mini-card" href="meusPets.html">
      <div class="mini-icon"><i class="fa-solid fa-paw"></i></div>
      <div class="mini-text"><b>Meus Pets</b><small>Gerencie seus bichinhos</small></div>
    </a>
    <a class="mini-card" href="alterar-senha.html">
      <div class="mini-icon"><i class="fa-solid fa-shield-halved"></i></div>
      <div class="mini-text"><b>Seguran√ßa</b><small>Senha e acesso</small></div>
    </a>
  </div>

  <div class="cols">
    
    <div class="sidebar-left">
        <div class="card">
        <div class="hd">Buscar servi√ßos <i class="fa-solid fa-sliders" style="color:#9ca3af; font-size:0.85rem;"></i></div>
        <div class="filters">
            <button class="chip-btn active" data-service="all"><i class="fa-solid fa-border-all"></i> Todos</button>
            <button class="chip-btn" data-service="daycare"><i class="fa-solid fa-sun"></i> Day Care</button>
            <button class="chip-btn" data-service="hospedagem"><i class="fa-solid fa-house-chimney"></i> Hospedagem</button>
            <button class="chip-btn" data-service="lar"><i class="fa-solid fa-heart"></i> Lar Tempor√°rio</button>
            
            <div style="margin-top: 10px;">
                <label style="font-weight:700;color:#374151; font-size:0.85rem; display:block; margin-bottom:6px;">Localiza√ß√£o</label>
                <select class="select" id="citySelect">
                <option value="all">Todas as cidades</option>
                <option value="Plano Piloto">Plano Piloto</option>
                <option value="Taguatinga">Taguatinga</option>
                <option value="Guar√°">Guar√°</option>
                <option value="Sobradinho">Sobradinho</option>
                </select>
            </div>
        </div>
        </div>
    </div>

    <div id="feed" class="feed"></div>

    <div class="sidebar-right">
        <div class="card">
        <div class="hd">Dica r√°pida üí°</div>
        <div class="help">
            <h4>Encontre o anfitri√£o ideal</h4>
            <p>Use os filtros ao lado para selecionar o tipo de servi√ßo que voc√™ precisa.</p>
            <p>Verifique as avalia√ß√µes de outros tutores para garantir a melhor escolha.</p>
            <a href="ajuda.html" style="display: flex; align-items: center; gap: 6px; margin-top: 10px;">
                Ver Central de Ajuda <i class="fa-solid fa-arrow-right" style="font-size: 0.75rem;"></i>
            </a>
        </div>
        </div>
    </div>

  </div>
</div>

<div id="modal" class="modal">
  <div class="box">
    <div class="box-hd">
      <h3 id="mName">Perfil do Anfitri√£o</h3>
      <button class="x" onclick="toggleModal(false)"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="box-bd" id="mBody"></div>
  </div>
</div>

<div class="pp-wrap" id="ppDelete">
  <div class="pp-card" role="dialog" aria-modal="true">
    <header>
      <span class="ic"><i class="fa-solid fa-exclamation"></i></span>
      <h4>Excluir sua conta</h4>
    </header>
    <div class="pp-body">
      <p>Esta a√ß√£o √© <strong>irrevers√≠vel</strong>. Seus dados de tutor, pets e hist√≥rico de reservas ser√£o permanentemente removidos.</p>
      <p>Para confirmar, digite <strong>EXCLUIR</strong> no campo abaixo:</p>
      <input id="delConfirmText" type="text" placeholder="Digite EXCLUIR aqui">
    </div>
    <div class="pp-ft">
      <button class="pp-btn" id="delCancel">Cancelar</button>
      <button class="pp-btn pp-ok" id="delOk">Confirmar Exclus√£o</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><i class="fa-solid fa-check-circle"></i> <span id="toastMsg">Mensagem</span></div>

<div class="pp-chat-fab" id="ppChatFab">
  <i class="fa-solid fa-comments"></i>
  <span class="pp-badge" id="ppBadge">!</span>
</div>

<div class="pp-chat-widget" id="ppChatWidget">
  <div class="pp-chat-header">
    <div>
      <strong>Mensagens</strong>
      <span id="ppChatSubtitle">Selecione uma conversa</span>
    </div>
    <button class="pp-chat-close" id="ppChatClose">
      <i class="fa-solid fa-minus"></i> </button>
  </div>

  <div class="pp-chat-body">
    <aside class="pp-chat-conversations">
      <div class="pp-chat-conv-list" id="ppChatConvList"></div>
    </aside>

    <section class="pp-chat-thread">
      <div class="pp-chat-messages" id="ppChatMessages"></div>
      
      <form class="pp-chat-input-area" id="ppChatForm">
        <input
          type="text"
          id="ppChatInput"
          placeholder="Digite sua mensagem..."
          autocomplete="off"
        />
        <button type="submit">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </form>
    </section>
  </div>
</div>

<footer>
  <div class="footer-inner">
    <span>¬© 2025 Patas Pousada ‚Äî √Årea do Tutor</span>
    <div class="footer-links">
      <a href="#">Termos de uso</a>
      <a href="#">Pol√≠tica de privacidade</a>
      <a href="ajuda.html">Ajuda</a>
    </div>
  </div>
</footer>

<script>
  // ===== Supabase =====
  const SUPABASE_URL     = "https://nwbgzokttjgkipwzfgzc.supabase.co";
  const SUPABASE_ANON_KEY= "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUserEmail = null;
  let currentUserId    = null;
  let HOSTS = [];

  function toast(msg){
    const t=document.getElementById('toast');
    document.getElementById('toastMsg').textContent=msg;
    t.style.display='flex';
    t.style.alignItems='center';
    t.style.gap='10px';
    setTimeout(()=>t.style.display='none',2500);
  }

  function initials(name){
    if(!name) return "U";
    const p=name.trim().split(/\s+/);
    const i1=(p[0]?.[0]||"").toUpperCase();
    const i2=(p[1]?.[0]||"").toUpperCase();
    return (i1+i2) || "U";
  }

  async function requireAuth(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){
      location.href = "cadastrarouentrar.html?next=home_tutor.html";
      return null;
    }
    currentUserEmail = user.email;
    currentUserId    = user.id;
    return user;
  }

  async function loadName(user){
    try{
      const { data } = await sb
        .from('profiles')
        .select('first_name,last_name,full_name,avatar_url')
        .eq('id', user.id)
        .maybeSingle();

      const emailPrefix = user.email.split('@')[0];
      let display = emailPrefix;
      let avatarUrl = null;

      if (data){
        if (data.first_name || data.last_name){
          const composed = `${data.first_name || ''} ${data.last_name || ''}`.trim();
          if (composed) display = composed;
        } else if (data.full_name && data.full_name.trim() !== ''){
          display = data.full_name;
        }
        avatarUrl = data.avatar_url;
      }

      if((display === emailPrefix || !display) && user.user_metadata?.full_name){
        display = user.user_metadata.full_name;
      }

      const finalName = display || emailPrefix;

      document.getElementById('userName').textContent  = finalName;
      document.getElementById('helloName').textContent = finalName;

      const avatarImg = document.getElementById('userAvatar');
      const initialBadge = document.getElementById('userInitial');

      if (avatarUrl) {
          const urlComCache = avatarUrl + '?t=' + new Date().getTime();
          avatarImg.src = urlComCache;
          avatarImg.style.display = 'block';
          initialBadge.style.display = 'none';
      } else {
          initialBadge.textContent = initials(finalName);
          initialBadge.style.display = 'grid';
          avatarImg.style.display = 'none';
      }

    }catch(e){
      console.error("Erro ao carregar nome do tutor:", e);
    }
  }

  const feed = document.getElementById('feed');

  // ============================================================
  // CARD DO HOST: FOTOS + DETALHES
  // ============================================================
  function hostCard(h){
    const services = h.service
      .map(s=>({daycare:"Day Care", hospedagem:"Hospedagem", lar:"Lar Tempor√°rio"}[s] || s))
      .join(", ");
    
    let photosHtml = '';
    let badgeHtml = '';
    const photos = (h.photos && h.photos.length > 0) ? h.photos : [h.img];

    if(photos.length > 1){
        badgeHtml = `<span class="photo-badge"><i class="fa-solid fa-camera"></i> ${photos.length}</span>`;
    }

    const imgs = photos.map(url => `<img src="${url}" alt="Foto do local" loading="lazy">`).join('');
    photosHtml = `
        <div class="photo-container">
            <div class="photo-scroll">
                ${imgs}
            </div>
            ${badgeHtml}
        </div>
    `;

    let availableText = "Disponibilidade n√£o informada";
    if(h.availableEnd){
        const d = new Date(h.availableEnd);
        availableText = `Dispon√≠vel at√© ${d.toLocaleDateString('pt-BR')}`;
    }

    let publishedText = "";
    if(h.createdAt){
        const datePub = new Date(h.createdAt);
        const now = new Date();
        const diffTime = Math.abs(now - datePub);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        publishedText = (diffDays <= 1) ? "Publicado hoje" : `Publicado h√° ${diffDays} dias`;
    }

    const capacityText = h.capacity ? `Aceita at√© ${h.capacity} pet(s)` : "Capacidade n√£o informada";

    const el = document.createElement('div');
    el.className='host';
    el.dataset.city = h.city;
    el.dataset.service = h.service.join(',');
    el.dataset.hostId = h.hostId;
    
    el.innerHTML = `
      ${photosHtml}
      <div class="body">
        <h3>${h.name} <span>‚Ä¢ ${h.city}</span></h3>
        <div class="meta">
          <span class="rating"><i class="fa-solid fa-star"></i> ${h.rating.toFixed(1)} <span style="color:#9ca3af;font-weight:400">(${h.reviews})</span></span>
          <span class="tag"><i class="fa-solid fa-briefcase"></i> ${services}</span>
        </div>
        
        <div class="meta-details">
            <div><i class="fa-solid fa-paw"></i> ${capacityText}</div>
            <div><i class="fa-regular fa-calendar-check"></i> ${availableText}</div>
            <div style="font-size:0.7rem; margin-top:2px;">${publishedText}</div>
        </div>

        <div class="about-text">
            ${h.about}
        </div>
      </div>
      <div class="cta">
        <div class="price">R$ ${h.price} <small>/dia</small></div>
        <button class="btn" type="button" onclick="openProfile(${h.id})">Ver perfil</button>
        <button class="btn btn-chat" type="button" data-host-id="${h.hostId}">Conversar</button>
      </div>`;
    return el;
  }

  function render(list){
    feed.innerHTML = "";
    if(!list.length){
      feed.innerHTML = `
        <div class="card">
          <div class="empty">
            <i class="fa-regular fa-face-frown-open" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
            Nenhum perfil encontrado para os filtros selecionados.
          </div>
        </div>`;
      return;
    }
    list.forEach(h => feed.appendChild(hostCard(h)));
  }

  let currentService = "all";
  let currentCity    = "all";

  function applyFilters(){
    const result = HOSTS.filter(h=>{
      const serviceOk = currentService==="all" || h.service.includes(currentService);
      const cityOk    = currentCity==="all" || h.city===currentCity;
      return serviceOk && cityOk;
    });
    render(result);
  }

  document.addEventListener('click', (ev)=>{
    const b = ev.target.closest('.chip-btn');
    if(!b) return;
    document.querySelectorAll('.chip-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentService = b.dataset.service;
    applyFilters();
  });

  document.getElementById('citySelect').addEventListener('change', e=>{
    currentCity = e.target.value;
    applyFilters();
  });

  // ============================================================
  // BUSCA DADOS DO BANCO (INCLUINDO NOME DO USU√ÅRIO)
  // ============================================================
  async function loadHostsAndListings(){
    try{
      feed.innerHTML = `
        <div class="card">
          <div class="empty">
            Carregando anfitri√µes e hospedagens...
          </div>
        </div>`;

      const { data: listings, error } = await sb
        .from('listings')
        .select('id, host_id, title, city, description, services, price_night, price_daycare, photos_url, available_end, created_at, capacity')
        .order('created_at', { ascending: false });

      if(error){
        console.error('Erro ao buscar listings:', error);
        feed.innerHTML = `
          <div class="card">
            <div class="empty" style="color:#b91c1c;">
              Erro ao carregar as hospedagens. Tente novamente mais tarde.
            </div>
          </div>`;
        return;
      }

      if(!listings || listings.length === 0){
        HOSTS = [];
        applyFilters();
        return;
      }

      const hostIds = [...new Set(listings.map(l => l.host_id).filter(Boolean))];

      let hostsMap = {};
      let profilesMap = {};

      if(hostIds.length){
        const { data: hostsData, error: hostsError } = await sb
          .from('hosts')
          .select('id, full_name, city, about, avatar_url')
          .in('id', hostIds);

        if(hostsError){
          console.error('Erro ao buscar hosts:', hostsError);
        }else if(hostsData){
          hostsData.forEach(h => {
            hostsMap[h.id] = h;
          });
        }

        const { data: profilesData, error: profilesError } = await sb
          .from('profiles')
          .select('id, first_name, last_name, full_name')
          .in('id', hostIds);

        if(profilesError){
          console.error('Erro ao buscar perfis:', profilesError);
        } else if(profilesData){
          profilesData.forEach(p => {
            profilesMap[p.id] = p;
          });
        }
      }

      HOSTS = listings.map(l => {
        const host = hostsMap[l.host_id] || {};
        const profile = profilesMap[l.host_id] || {};
        const servicesArray = Array.isArray(l.services) ? l.services : [];

        const normalizedServices = servicesArray.map(s=>{
          const lower = (s || '').toLowerCase();
          if(lower.includes('day')) return 'daycare';
          if(lower.includes('hosp')) return 'hospedagem';
          if(lower.includes('lar')) return 'lar';
          return lower || 'hospedagem';
        });

        const avatar = host.avatar_url || "https://cdn-icons-png.flaticon.com/512/1373/1373255.png";

        const profileNameFromParts = `${(profile.first_name || '').trim()} ${(profile.last_name || '').trim()}`.trim();

        const displayName =
          (host.full_name && host.full_name.trim()) ||
          (profile.full_name && profile.full_name.trim()) ||
          profileNameFromParts ||
          'Anfitri√£o';

        return {
          id: l.id,
          hostId: l.host_id,
          name: displayName,
          city: l.city || host.city || 'Bras√≠lia',
          service: normalizedServices.length ? normalizedServices : ['hospedagem'],
          price: l.price_night || l.price_daycare || 0,
          img: avatar,
          photos: l.photos_url || [],
          about: l.description || host.about || 'Anfitri√£o ainda n√£o adicionou uma descri√ß√£o.',
          rating: 5.0,
          reviews: 0,
          availableEnd: l.available_end,
          createdAt: l.created_at,
          capacity: l.capacity
        };
      });

      applyFilters();
    }catch(e){
      console.error('Erro inesperado ao carregar an√∫ncios:', e);
      feed.innerHTML = `
        <div class="card">
          <div class="empty" style="color:#b91c1c;">
            Erro ao carregar as hospedagens.
          </div>
        </div>`;
    }
  }

  function toggleModal(show){
    const modal = document.getElementById('modal');
    if(show) {
        modal.classList.add('show');
    } else {
        modal.classList.remove('show');
    }
  }

  // ============================================================
  // MODAL: DETALHES
  // ============================================================
  function openProfile(id){
    const h = HOSTS.find(x=>x.id===id); 
    if(!h) return;

    const hostIdForChat = h.hostId;
    
    document.getElementById('mName').innerHTML = `${h.name} <span style="font-weight:400; font-size:1rem; color:#6b7280; margin-left:8px;">${h.city}</span>`;
    
    const servicesBadges = h.service.map(s => {
        let icon = '';
        let label = '';
        if(s === 'daycare') { icon = 'fa-sun'; label = 'Day Care'; }
        if(s === 'hospedagem') { icon = 'fa-house'; label = 'Hospedagem'; }
        if(s === 'lar') { icon = 'fa-heart'; label = 'Lar Temp.'; }
        if(!label) { label = s; }
        return `<span style="background:#fff0ec; color:#e2725b; padding:4px 10px; border-radius:20px; font-size:0.85rem; font-weight:600; display:inline-flex; align-items:center; gap:6px;"><i class="fa-solid ${icon}"></i> ${label}</span>`;
    }).join(' ');

    let modalPhotos = '';
    if(h.photos && h.photos.length > 0){
        modalPhotos = h.photos.map(url => 
            `<img src="${url}" style="width:100px; height:100px; border-radius:12px; object-fit:cover; background:#f3f4f6; border: 1px solid #eee;">`
        ).join('');
    } else {
        modalPhotos = `<img src="${h.img}" style="width:100px; height:100px; border-radius:12px; object-fit:cover;">`;
    }

    const capacityText = h.capacity ? `${h.capacity} pet(s)` : 'N√£o informado';
    const availableText = h.availableEnd
      ? new Date(h.availableEnd).toLocaleDateString('pt-BR')
      : 'N√£o informada';
    const publishedText = h.createdAt
      ? new Date(h.createdAt).toLocaleDateString('pt-BR')
      : 'N√£o informado';

    document.getElementById('mBody').innerHTML = `
      <div style="display:flex; gap:24px; align-items:flex-start; flex-direction: column;">
        
        <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; width:100%;">
            ${modalPhotos}
        </div>

        <div style="width:100%;">
          <div style="display:flex; align-items:center; gap:6px; color:#f59e0b; font-weight:700; font-size:1.1rem; margin-bottom:8px;">
            <i class="fa-solid fa-star"></i> ${h.rating.toFixed(1)} 
            <span style="color:#9ca3af; font-weight:400; font-size:0.9rem;">(${h.reviews} avalia√ß√µes)</span>
          </div>
          
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
            ${servicesBadges}
          </div>

          <p style="margin:0; color:#374151; line-height:1.6;">${h.about}</p>

          <div style="margin-top:14px; font-size:0.88rem; color:#6b7280; display:flex; flex-direction:column; gap:4px;">
            <div><i class="fa-solid fa-paw" style="width:14px; text-align:center; margin-right:6px; color:#9ca3af;"></i><strong>Capacidade:</strong> ${capacityText}</div>
            <div><i class="fa-regular fa-calendar-check" style="width:14px; text-align:center; margin-right:6px; color:#9ca3af;"></i><strong>Dispon√≠vel at√©:</strong> ${availableText}</div>
            <div><i class="fa-regular fa-clock" style="width:14px; text-align:center; margin-right:6px; color:#9ca3af;"></i><strong>Publicado em:</strong> ${publishedText}</div>
          </div>
        </div>
      </div>

      <div style="margin-top:24px; padding-top:20px; border-top:1px solid #f3f4f6; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
            <span style="display:block; font-size:0.85rem; color:#6b7280;">Valor da di√°ria</span>
            <span style="font-size:1.5rem; font-weight:800; color:#e2725b;">R$ ${h.price},00</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" style="background:var(--brand); color:#fff; padding:10px 18px; font-size:0.95rem; border:none; box-shadow: 0 4px 12px rgba(226, 114, 91, 0.3);" onclick="alert('Funcionalidade de reserva em breve!')">
            Solicitar Reserva
          </button>
          <button class="btn" style="padding:10px 18px; font-size:0.9rem;" onclick="startChatWithHost('${hostIdForChat}')">
            Conversar com anfitri√£o
          </button>
        </div>
      </div>
    `;
    toggleModal(true);
  }

  document.getElementById('modal').addEventListener('click', e=>{
    if(e.target.id==='modal') toggleModal(false);
  });

  const ppDelete       = document.getElementById('ppDelete');
  const delCancel      = document.getElementById('delCancel');
  const delOk          = document.getElementById('delOk');
  const delConfirmText = document.getElementById('delConfirmText');

  function openDeleteModal(){
    ppDelete.style.display='flex';
    requestAnimationFrame(()=>{
      ppDelete.querySelector('.pp-card').classList.add('show');
    });
  }

  function closeDeleteModal(){
    const card = ppDelete.querySelector('.pp-card');
    card.classList.remove('show');
    setTimeout(()=>{ ppDelete.style.display='none'; }, 200);
    delConfirmText.value='';
  }

  ppDelete.addEventListener('click', (e)=>{
    if(e.target.id === 'ppDelete') closeDeleteModal();
  });

  delCancel.addEventListener('click', (e)=>{
    e.preventDefault();
    closeDeleteModal();
  });

  // *** AQUI EST√Å O PONTO PRINCIPAL: chamar PHP para excluir no Supabase Auth ***
  async function handleDeleteAccount(){
    if(!currentUserId){
      toast("Erro: usu√°rio n√£o identificado. Fa√ßa login novamente.");
      return;
    }

    const text = delConfirmText.value.trim().toUpperCase();
    if(text !== "EXCLUIR"){
      toast("Por favor, digite EXCLUIR para confirmar.");
      return;
    }

    try{
      // fecha o modal visualmente
      closeDeleteModal();

      // chama o backend que usa a SERVICE ROLE KEY
      const resp = await fetch('processaExclusao.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: currentUserId,
          email: currentUserEmail
        })
      });

      let result = {};
      try {
        result = await resp.json();
      } catch(e) {
        result = { ok:false, message:'Resposta inv√°lida do servidor.' };
      }

      if(!resp.ok || !result.ok){
        toast(result.message || 'Erro ao excluir conta.');
        return;
      }

      toast("Conta exclu√≠da com sucesso.");

      // encerra sess√£o no front
      try{ await sb.auth.signOut(); }catch(e){}

      setTimeout(()=>{
        window.location.href = "cadastrarouentrar.html";
      }, 1500);

    }catch(e){
      console.error("Erro ao excluir conta:", e);
      toast("Erro ao excluir conta.");
    }
  }

  delOk.addEventListener('click', async (e)=>{
    e.preventDefault();
    await handleDeleteAccount();
  });

  document.getElementById('deleteAccountLink')?.addEventListener('click', (e)=>{
    e.preventDefault();
    if(!currentUserId){
      toast("Erro: sess√£o expirada.");
      return;
    }
    openDeleteModal();
  });

  document.getElementById('logoutLink').addEventListener('click', async e=>{
    e.preventDefault();
    try{ await sb.auth.signOut(); }catch(e){}
    location.href="cadastrarouentrar.html";
  });

  // ============ CHAT ============
  let ppChatUser = null;
  let ppActiveChatId = null;
  let ppChatChannel = null;
  let ppGlobalMessagesChannel = null;

  const ppChatFab       = document.getElementById('ppChatFab');
  const ppChatWidget    = document.getElementById('ppChatWidget');
  const ppChatClose     = document.getElementById('ppChatClose');
  const ppChatConvList  = document.getElementById('ppChatConvList');
  const ppChatMessages  = document.getElementById('ppChatMessages');
  const ppChatForm      = document.getElementById('ppChatForm');
  const ppChatInput     = document.getElementById('ppChatInput');
  const ppChatSubtitle  = document.getElementById('ppChatSubtitle');
  const ppBadge         = document.getElementById('ppBadge');

  ppChatFab?.addEventListener('click', () => {
    ppChatWidget.style.display = 'flex';
    ppChatFab.style.display = 'none';
    ppBadge.classList.remove('show');
  });

  ppChatClose?.addEventListener('click', () => {
    ppChatWidget.style.display = 'none';
    ppChatFab.style.display = 'grid';
  });

  async function startChatWithHost(hostId, bookingId = null) {
    if (!hostId) {
      toast("Erro: anfitri√£o n√£o identificado.");
      return;
    }
    if (!currentUserId) {
      const user = await requireAuth();
      if (!user) return;
    }

    try {
      let query = sb
        .from('chats')
        .select('*')
        .eq('tutor_id', currentUserId)
        .eq('host_id', hostId)
        .order('created_at', { ascending: false })
        .limit(1);

      if (bookingId) {
        query = query.eq('booking_id', bookingId);
      } else {
        query = query.is('booking_id', null);
      }

      const { data: existing, error: findError } = await query;

      if (findError) {
        console.error('Erro ao buscar chat existente:', findError);
      }

      let chatRow = existing && existing.length ? existing[0] : null;

      if (!chatRow) {
        const { data, error } = await sb
          .from('chats')
          .insert({
            tutor_id: currentUserId,
            host_id: hostId,
            booking_id: bookingId
          })
          .select('*')
          .single();

        if (error) {
          console.error('Erro ao criar chat:', error);
          toast('N√£o foi poss√≠vel abrir o chat agora.');
          return;
        }
        chatRow = data;
      }

      await ppLoadConversations();
      ppChatWidget.style.display = 'flex';
      ppChatFab.style.display    = 'none';
      ppBadge.classList.remove('show');
      await ppOpenConversation(chatRow);
    } catch (e) {
      console.error('Erro inesperado ao iniciar chat:', e);
      toast('Erro ao iniciar chat.');
    }
  }

  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('.btn-chat');
    if (!btn) return;
    const hostId = btn.dataset.hostId || btn.closest('.host')?.dataset.hostId;
    await startChatWithHost(hostId);
  });

  function ppInitGlobalMessageWatcher() {
    if (!ppChatUser || ppGlobalMessagesChannel) return;

    ppGlobalMessagesChannel = sb
      .channel('chat-global-' + ppChatUser.id)
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'messages' },
        async (payload) => {
          const msg = payload.new;
          if (!msg) return;
          if (msg.sender_id === ppChatUser.id) return;

          try {
            const { data: chatRow, error } = await sb
              .from('chats')
              .select('id,tutor_id,host_id')
              .eq('id', msg.chat_id)
              .maybeSingle();

            if (error || !chatRow) return;

            if (chatRow.tutor_id !== ppChatUser.id && chatRow.host_id !== ppChatUser.id) {
              return;
            }

            if (ppChatWidget.style.display === 'none' || ppChatWidget.style.display === '') {
              ppBadge.classList.add('show');
              ppChatFab.style.display = 'grid';
            }

            ppLoadConversations();
          } catch (e) {
            console.error('Erro ao processar mensagem global:', e);
          }
        }
      )
      .subscribe();
  }

  async function ppInitChat() {
    if (!currentUserId) {
      const { data, error } = await sb.auth.getUser();
      if (error || !data?.user) {
        console.warn('Nenhum usu√°rio logado para o chat.');
        return;
      }
      ppChatUser = data.user;
    } else {
      ppChatUser = { id: currentUserId, email: currentUserEmail };
    }
    await ppLoadConversations();
    ppInitGlobalMessageWatcher();
  }

  async function deleteChat(chatId){
    if (!chatId) return;
    try{
      await sb.from('messages').delete().eq('chat_id', chatId);
      const { error } = await sb.from('chats').delete().eq('id', chatId);
      if (error){
        console.error('Erro ao excluir chat:', error);
        toast('N√£o foi poss√≠vel excluir a conversa.');
        return;
      }

      if (ppActiveChatId === chatId){
        ppActiveChatId = null;
        ppChatMessages.innerHTML = '';
        ppChatSubtitle.textContent = 'Selecione uma conversa';
        if (ppChatChannel){
          sb.removeChannel(ppChatChannel);
          ppChatChannel = null;
        }
      }
      await ppLoadConversations();
      toast('Conversa exclu√≠da.');
    }catch(e){
      console.error('Erro inesperado ao excluir chat:', e);
      toast('Erro ao excluir conversa.');
    }
  }

  async function ppLoadConversations() {
    if (!ppChatUser) return;

    const { data, error } = await sb
      .from('chats')
      .select('*')
      .or(`tutor_id.eq.${ppChatUser.id},host_id.eq.${ppChatUser.id}`)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Erro ao carregar conversas:', error);
      return;
    }

    ppChatConvList.innerHTML = '';

    if (!data || data.length === 0) {
      ppChatConvList.innerHTML = `
        <div style="font-size:0.8rem;color:#6b7280;padding:8px;">
          Sem conversas ainda.
        </div>`;
      return;
    }

    const unique = [];
    const seen = new Set();
    data.forEach(chat => {
      const key = `${chat.tutor_id || 't'}-${chat.host_id || 'h'}-${chat.booking_id || 'null'}`;
      if (!seen.has(key)){
        seen.add(key);
        unique.push(chat);
      }
    });

    const hostIds = unique.map(c => c.host_id);
    let hostsMap = {};
    if(hostIds.length > 0){
       const { data: hostsData } = await sb
         .from('hosts')
         .select('id, full_name')
         .in('id', hostIds);
       if(hostsData){
         hostsData.forEach(h => {
            hostsMap[h.id] = h.full_name;
         });
       }
    }

    unique.forEach(chat => {
      const otherName = hostsMap[chat.host_id] || "Anfitri√£o";
      const roleLabel = "Anfitri√£o"; 

      const item = document.createElement('div');
      item.className = 'pp-chat-conv-item';
      item.dataset.id = chat.id;
      item.innerHTML = `
        <button class="pp-chat-delete" type="button" data-chat-id="${chat.id}" aria-label="Excluir conversa">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <span class="pp-chat-conv-name">${otherName}</span>
        <div class="pp-chat-conv-role">${roleLabel}</div>
        <span class="pp-chat-conv-meta">
          ${chat.booking_id ? 'Reserva vinculada' : 'Sem reserva'}
        </span>
      `;
      item.addEventListener('click', () => ppOpenConversation(chat));
      ppChatConvList.appendChild(item);
    });
  }

  function ppSetActiveConversation(chatId) {
    document.querySelectorAll('.pp-chat-conv-item').forEach(item => {
      item.classList.toggle('active', item.dataset.id === chatId);
    });
  }

  async function ppOpenConversation(chat) {
    ppActiveChatId = chat.id;
    ppSetActiveConversation(chat.id);
    
    const nameEl = document.querySelector(`.pp-chat-conv-item[data-id="${chat.id}"] .pp-chat-conv-name`);
    const chatName = nameEl ? nameEl.textContent : "Chat";
    ppChatSubtitle.textContent = chat.booking_id ? `Reserva ‚Ä¢ ${chatName}` : chatName;

    ppChatMessages.innerHTML = '<div style="font-size:0.8rem;color:#9ca3af;text-align:center;margin-top:8px;">Carregando mensagens...</div>';

    if (ppChatChannel) {
      sb.removeChannel(ppChatChannel);
      ppChatChannel = null;
    }

    const { data, error } = await sb
      .from('messages')
      .select('*')
      .eq('chat_id', chat.id)
      .order('created_at', { ascending: true });

    if (error) {
      console.error('Erro ao carregar mensagens:', error);
      ppChatMessages.innerHTML = '<div style="font-size:0.8rem;color:#b91c1c;text-align:center;margin-top:8px;">Erro ao carregar mensagens.</div>';
      return;
    }

    ppChatMessages.innerHTML = '';
    data.forEach(msg => ppRenderMessage(msg));
    ppScrollToBottom();

    ppChatChannel = sb
      .channel('chat-' + chat.id)
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'messages', filter: 'chat_id=eq.' + chat.id },
        payload => {
          ppRenderMessage(payload.new);
          ppScrollToBottom();
          if(ppChatWidget.style.display === 'none' || ppChatWidget.style.display === '') {
             ppBadge.classList.add('show');
          }
        }
      )
      .subscribe();
  }

  function ppRenderMessage(msg) {
    if (!ppChatUser) return;
    const isMe = msg.sender_id === ppChatUser.id;

    const row = document.createElement('div');
    row.className = 'pp-chat-msg-row ' + (isMe ? 'me' : 'other');

    const created = msg.created_at ? new Date(msg.created_at) : new Date();
    const hh = String(created.getHours()).padStart(2,'0');
    const mm = String(created.getMinutes()).padStart(2,'0');
    const time = `${hh}:${mm}`;

    row.innerHTML = `
      <div class="pp-chat-bubble ${isMe ? 'me' : 'other'}">
        <div>${msg.content}</div>
        <div class="pp-chat-time">${time}</div>
      </div>
    `;
    ppChatMessages.appendChild(row);
  }

  function ppScrollToBottom() {
    ppChatMessages.scrollTop = ppChatMessages.scrollHeight;
  }

  ppChatConvList.addEventListener('click', async (ev) => {
    const delBtn = ev.target.closest('.pp-chat-delete');
    if (!delBtn) return;
    ev.stopPropagation();
    const chatId = delBtn.dataset.chatId;
    if (!chatId) return;
    if (!confirm('Deseja excluir esta conversa?')) return;
    await deleteChat(chatId);
  });

  ppChatForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!ppActiveChatId || !ppChatUser) return;

    const text = ppChatInput.value.trim();
    if (!text) return;

    ppChatInput.value = '';

    const { error } = await sb
      .from('messages')
      .insert({
        chat_id: ppActiveChatId,
        sender_id: ppChatUser.id,
        content: text
      });

    if (error) {
      console.error('Erro ao enviar mensagem:', error);
    }
  });

  (async function init(){
    const user = await requireAuth();
    if(!user) return;

    await loadName(user);
    await loadHostsAndListings();
    await ppInitChat();
  })();
</script>
</body>
</html>
