<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Meus Pets ‚Äî Patas Pousada</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');

  :root{
    --brand:#e2725b; --brand-strong:#d45f47; --ink:#333; --muted:#777; --bg:#f7f7f7; --white:#fff;
    --radius:12px; --shadow:0 6px 14px rgba(0,0,0,.08); --line:#ececec;
    --chip:#fff4f1; --chip-border:#ffd8cf;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Nunito,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  a{color:inherit;text-decoration:none}

  /* HEADER */
  header{display:flex;justify-content:center;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
  nav{max-width:1200px;width:100%;padding:16px 20px;display:flex;align-items:center;gap:20px}
  .logo{display:flex;align-items:center;text-decoration:none;color:var(--brand);font-family:Parkinsans,sans-serif;font-weight:800}
  .logo img{width:30px;height:30px;margin-right:10px}
  nav ul{list-style:none;display:flex;gap:22px;margin:0 0 0 auto;padding:0}
  nav ul a{font-family:Parkinsans,sans-serif;font-weight:700;text-decoration:none;color:#222}
  nav ul a:hover{color:var(--brand)}
  .pill{color:#d74f4f}

  /* User menu */
  .user-menu{position:relative; display: none;}
  .user-trigger{display:flex;align-items:center;gap:10px;cursor:pointer}
  .user-trigger img{width:32px;height:32px;border-radius:50%;border:1px solid #eee;background:#f2f2f2;object-fit:cover}
  .user-trigger svg{width:14px;height:14px;fill:#666;transition:transform .2s}
  .user-menu:hover .user-trigger svg{transform:rotate(180deg)}
  .dropdown{position:absolute;top:calc(100% + 6px);right:0;background:#fff;border:1px solid #e6e6e6;border-radius:8px;box-shadow:var(--shadow);width:220px;opacity:0;visibility:hidden;transform:translateY(6px);transition:.15s;z-index:30}
  .user-menu:hover .dropdown{opacity:1;visibility:visible;transform:translateY(0)}
  .dropdown a{display:flex;gap:10px;padding:10px 12px;text-decoration:none;color:#333;font-weight:800}
  .dropdown a:hover{background:#f7f7f7}

  /* P√°gina */
  .wrap{max-width:1000px;margin:28px auto;padding:0 20px}
  h2{font:800 28px Parkinsans,sans-serif;color:var(--brand);text-align:left;margin:6px 0 22px}

  .actions-top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:24px; align-items: center;}
  .btn-pill{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--brand);color:var(--brand);background:#fff;padding:8px 16px;border-radius:999px;font-weight:900;text-decoration:none;font-size:0.9rem}
  .btn-pill:hover{background:#fff1ee}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-primary:hover{background:var(--brand-strong)}

  /* GRID E CARDS COMPACTOS */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
  }
  
  .card {
    background: #fff; border: 1px solid #eee; border-radius: 16px; 
    box-shadow: 0 2px 6px rgba(0,0,0,.04); overflow: hidden;
    display: flex;
    align-items: center;
    padding: 12px 16px;
    transition: transform 0.2s;
  }
  .card:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,.08); }

  .photo {
    width: 60px; height: 60px; 
    border-radius: 50%; 
    background: #f9f9f9; border: 1px solid #eee;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; flex-shrink: 0;
    margin-right: 14px;
  }
  .photo img { width: 100%; height: 100%; object-fit: cover; }
  .photo-placeholder { font-size: 1.6rem; color: #ddd; }

  .body {
    flex: 1; text-align: left; padding: 0;
    display: flex; flex-direction: column; justify-content: center;
  }
  .body h3 {
    margin: 0 0 2px; color: var(--ink); 
    font: 800 1rem Parkinsans,sans-serif;
  }
  .body p {
    margin: 0; color: #666; font-size: 0.85rem; 
    line-height: 1.4;
  }
  
  .card-cta {
    display: flex; gap: 8px; padding: 0; margin-left: 10px;
  }
  .btn-icon {
    all: unset; display: flex; align-items: center; justify-content: center;
    width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
    border: 1px solid #eee; color: #666; transition: 0.2s;
  }
  .btn-icon:hover { background: #f5f5f5; color: var(--brand); border-color: var(--brand); }
  .btn-delete:hover { background: #fff5f5; color: #cc0000; border-color: #cc0000; }

  .empty{padding:30px;border:2px dashed #eee;border-radius:12px;color:#888;background:#fff;text-align:center}

  /* Modal edi√ß√£o */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:50}
  .modal.show{display:grid}
  .box{background:#fff;border-radius:16px;max-width:640px;width:92%;box-shadow:var(--shadow);overflow:hidden}
  .box-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
  .box-hd h3{margin:0;font:800 18px Parkinsans,sans-serif}
  .box-bd{padding:16px;max-height:70vh;overflow:auto}
  .box-bd label{display:block;margin:10px 0 4px;font-weight:700; font-size: 0.9rem;}
  .box-bd input, .box-bd select, .box-bd textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px; font-family: inherit;}
  .box-ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid var(--line);background:#fafafa}
  .x{cursor:pointer;border:none;background:transparent;font-size:20px}

  /* Pretty Confirm */
  .pp-wrap{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:60}
  .pp-card{width:min(460px,92vw);background:#fff;border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.35);overflow:hidden;transform:translateY(8px);opacity:0;transition:.18s}
  .pp-card.show{transform:translateY(0);opacity:1}
  .pp-card header{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #f1f5f9;background:#fff1f0}
  .pp-card header .ic{width:20px;height:20px;display:grid;place-items:center;border-radius:999px;background:#fee2e2;color:#b91c1c;font-weight:900}
  .pp-card h4{margin:0;font-weight:900;color:#991b1b}
  .pp-body{padding:16px}
  .pp-ft{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;background:#fafafa;border-top:1px solid #eef2f7}
  .pp-btn{border-radius:12px;padding:9px 14px;font-weight:900;border:2px solid #e2e8f0;background:#fff;cursor:pointer}
  .pp-ok{background:#b91c1c;color:#fff;border-color:#b91c1c}

  /* Toast */
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.25);font-size:.92rem;display:none;z-index:70}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <nav>
    <a href="index.html" class="logo">
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="">
      <span>Patas Pousada</span>
    </a>

    <ul>
      <li><a href="reservas.html">Reservas</a></li>
      <li><a href="ajuda.html">Ajuda</a></li>
      <li><a class="pill" href="#">Lar Tempor√°rio</a></li>

      <li class="user-menu" id="userMenuRoot" style="display:none">
        <div class="user-trigger">
          <img id="userAvatar" alt="avatar">
          <strong id="userName">Usu√°rio</strong>
          <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5H7z"></path></svg>
        </div>
        <div class="dropdown">
          <a href="menu_perfil.html"><i class="fa-solid fa-user-pen"></i> Editar perfil</a>
          <a href="meusPets.html"><i class="fa-solid fa-paw"></i> Meus pets</a>
          <a href="#" id="logoutLink"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</a>
          <div style="height:1px;background:#eee;margin:6px 0"></div>
          <a href="#" id="deleteAccountLink" style="color:#b91c1c;font-weight:900;">
            <i class="fa-solid fa-user-xmark"></i> Excluir conta
          </a>
        </div>
      </li>
    </ul>
  </nav>
</header>

<div class="wrap">
  <div class="actions-top">
    <h2>üêæ Meus Pets</h2>
    <div>
       <a class="btn-pill" href="home_tutor.html"><i class="fa-solid fa-arrow-left"></i> Voltar</a>
       <a class="btn-pill btn-primary" href="cadastroPets.html"><i class="fa-solid fa-plus"></i> Novo Pet</a>
    </div>
  </div>

  <div id="petsWrap">
    <div class="empty"><i class="fa-solid fa-spinner fa-spin"></i> Carregando...</div>
  </div>
</div>

<!-- MODAL EDI√á√ÉO -->
<div id="editModal" class="modal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="box-hd">
      <h3>Editar Pet</h3>
      <button class="x" id="closeEdit">√ó</button>
    </div>
    <div class="box-bd">
      <form id="editForm">
        <input type="hidden" id="edit_id">
        <label>Nome</label>
        <input type="text" id="edit_name" required>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div><label>Esp√©cie</label><input type="text" id="edit_species" required></div>
            <div><label>Ra√ßa</label><input type="text" id="edit_breed"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
                <label>Sexo</label>
                <select id="edit_sex"><option value="Macho">Macho</option><option value="F√™mea">F√™mea</option></select>
            </div>
            <div>
                <label>Porte</label>
                <select id="edit_size"><option value="Pequeno">Pequeno</option><option value="M√©dio">M√©dio</option><option value="Grande">Grande</option></select>
            </div>
        </div>
        <label>Observa√ß√µes</label>
        <textarea id="edit_notes" rows="3"></textarea>
        <label>Foto (URL)</label>
        <input type="url" id="edit_photo_url" placeholder="https://...">
      </form>
    </div>
    <div class="box-ft">
      <button class="btn-pill" id="cancelEdit" style="border:1px solid #ddd;color:#555;background:#fff;cursor:pointer">Cancelar</button>
      <button class="btn-pill btn-primary" id="saveEdit" style="cursor:pointer">Salvar</button>
    </div>
  </div>
</div>

<!-- CONFIRM EXCLUIR PET -->
<div class="pp-wrap" id="ppConfirm" aria-hidden="true">
  <div class="pp-card">
    <header><span class="ic">!</span><h4>A√ß√£o irrevers√≠vel</h4></header>
    <div class="pp-body"><p id="ppMsg">Tem certeza?</p></div>
    <div class="pp-ft">
      <button class="pp-btn" id="ppCancel">Cancelar</button>
      <button class="pp-btn pp-ok" id="ppOk">Sim, excluir</button>
    </div>
  </div>
</div>

<!-- CONFIRM EXCLUIR CONTA -->
<div class="pp-wrap" id="ppDelete" style="display:none">
  <div class="pp-card">
    <header><span class="ic">!</span><h4>Excluir sua conta</h4></header>
    <div class="pp-body">
      <p>Esta a√ß√£o √© <strong>irrevers√≠vel</strong>. Todos os seus dados ser√£o removidos.</p>
      <p>Para confirmar, digite <strong>EXCLUIR</strong>:</p>
      <input id="delConfirmText" type="text" placeholder="EXCLUIR" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin:6px 0 10px">
    </div>
    <div class="pp-ft">
      <button class="pp-btn" id="delCancel">Cancelar</button>
      <button class="pp-btn pp-ok" id="delOk">Sim, excluir</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const petsWrap = document.getElementById('petsWrap');
  const userMenuRoot = document.getElementById('userMenuRoot');
  const userName = document.getElementById('userName');
  const userAvatar = document.getElementById('userAvatar');
  const logoutLink = document.getElementById('logoutLink');
  const deleteAccountLink = document.getElementById('deleteAccountLink');

  function toast(text){
      const t=document.getElementById('toast');
      t.textContent=text; t.style.display='block';
      setTimeout(()=>t.style.display='none', 2500);
  }

  function initialsFromName(name){
    if(!name) return 'üôÇ';
    const parts = name.trim().split(/\s+/);
    const p1 = parts[0]?.[0] || '';
    const p2 = parts[1]?.[0] || '';
    return (p1 + p2).toUpperCase() || 'üôÇ';
  }

  // ========== 1. Auth + HEADER (AQUI MUDA PRA PEGAR NOME CERTO) ==========
  async function initUser(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){
      location.href = "cadastrarouentrar.html?next=meusPets.html";
      return null;
    }

    const emailPrefix = user.email.split('@')[0];
    let display = emailPrefix;
    let avatarUrl = null;

    try {
      // tenta buscar na tabela profiles
      const { data } = await sb
        .from('profiles')
        .select('full_name, avatar_url')
        .eq('id', user.id)
        .maybeSingle();

      if (data) {
        if (data.full_name && data.full_name.trim() !== '') {
          display = data.full_name;
        }
        if (data.avatar_url) {
          avatarUrl = data.avatar_url;
        }
      }
    } catch (e) {
      console.error('Erro buscando profile:', e);
    }

    // se n√£o tiver full_name na tabela, tenta do metadata do Auth
    if ((display === emailPrefix || !display) && user.user_metadata?.full_name) {
      display = user.user_metadata.full_name;
    }

    // se n√£o tiver avatar na tabela, tenta do metadata
    if (!avatarUrl && user.user_metadata?.avatar_url) {
      avatarUrl = user.user_metadata.avatar_url;
    }

    userName.textContent = display || emailPrefix;

    // avatar
    if (avatarUrl) {
      userAvatar.src = avatarUrl;
      userAvatar.style.display = 'inline';
    } else {
      const c = document.createElement('canvas');
      c.width = 64; c.height = 64;
      const cx = c.getContext('2d');
      cx.fillStyle='#ffe6e6';
      cx.fillRect(0,0,64,64);
      cx.fillStyle='#e2725b';
      cx.font='bold 26px Nunito';
      cx.textAlign='center';
      cx.textBaseline='middle';
      cx.fillText(initialsFromName(display || emailPrefix), 32, 34);
      userAvatar.src = c.toDataURL();
      userAvatar.style.borderRadius = '50%';
      userAvatar.style.display = 'inline';
    }

    userMenuRoot.style.display = 'flex';
    return user;
  }

  logoutLink.addEventListener('click', async (e)=>{
     e.preventDefault();
     await sb.auth.signOut();
     location.href = "cadastrarouentrar.html";
  });

  // ========== 2. GRID DE PETS ==========
  function petCardHtml(p){
      const photoContent = p.photo_url 
          ? `<img src="${p.photo_url}" alt="${p.name || 'Pet'}">` 
          : `<i class="fa-solid fa-paw photo-placeholder"></i>`;

      return `
      <div class="card">
          <div class="photo">
              ${photoContent}
          </div>
          <div class="body">
              <h3>${p.name || 'Sem nome'}</h3>
              <p>${p.species || '-'} ‚Ä¢ ${p.breed || 'SRD'}</p>
              <p style="color:#999;font-size:0.8rem">${p.sex||'--'} ‚Ä¢ ${p.size||'--'}</p>
          </div>
          <div class="card-cta">
              <button class="btn-icon" onclick="startEdit('${p.id}')" title="Editar">
                  <i class="fa-solid fa-pen"></i>
              </button>
              <button class="btn-icon btn-delete" onclick="deletePet('${p.id}', '${p.name || 'este pet'}')" title="Excluir">
                  <i class="fa-solid fa-trash"></i>
              </button>
          </div>
      </div>`;
  }

  async function loadPets(user){
    petsWrap.innerHTML = `<div class="empty"><i class="fa-solid fa-spinner fa-spin"></i> Carregando...</div>`;
    const { data, error } = await sb.from('pets')
      .select('id,name,species,breed,sex,size,photo_url')
      .eq('owner_id', user.id)
      .order('created_at', { ascending: false });

    if(error) {
      petsWrap.innerHTML=`<div class="empty">Erro: ${error.message}</div>`;
      return;
    }
    
    if(!data || data.length === 0) { 
        petsWrap.innerHTML=`<div class="empty">Voc√™ ainda n√£o tem pets cadastrados. <a href="cadastroPets.html">Cadastrar agora</a></div>`; 
        return; 
    }

    petsWrap.innerHTML = '<div class="grid"></div>';
    const grid = petsWrap.querySelector('.grid');

    data.forEach(p => {
        grid.insertAdjacentHTML('beforeend', petCardHtml(p));
    });
  }

  // ========== 3. CONFIRM DELETE PET ==========
  const ppConfirm = document.getElementById('ppConfirm');
  const ppMsg = document.getElementById('ppMsg');
  const ppOk = document.getElementById('ppOk');
  const ppCancel = document.getElementById('ppCancel');

  function prettyConfirm(message){
    return new Promise(res=>{
      ppMsg.textContent = message;
      ppConfirm.style.display='flex'; 
      requestAnimationFrame(()=>ppConfirm.querySelector('.pp-card').classList.add('show'));
      const cleanup=v=>{ 
          ppConfirm.querySelector('.pp-card').classList.remove('show'); 
          setTimeout(()=>{ppConfirm.style.display='none';},140); 
          res(v); 
      };
      ppOk.onclick=()=>cleanup(true);
      ppCancel.onclick=()=>cleanup(false);
      ppConfirm.onclick = (e)=>{ if(e.target.id === 'ppConfirm') cleanup(false); };
    });
  }

  window.deletePet = async (id, name) => {
      if(await prettyConfirm(`Excluir ${name}?`)){
          const { error } = await sb.from('pets').delete().eq('id', id);
          if(error) { toast('Erro: ' + error.message); }
          else { 
              toast('Pet removido!');
              const { data:{ user } } = await sb.auth.getUser();
              loadPets(user); 
          }
      }
  }

  // ========== 4. EDITAR PET ==========
  const editModal = document.getElementById('editModal');
  const editForm = document.getElementById('editForm');

  window.startEdit = async (id) => {
      const { data, error } = await sb.from('pets').select('*').eq('id', id).single();
      if(error || !data){
        toast('Erro ao carregar pet para edi√ß√£o.');
        return;
      }
      document.getElementById('edit_id').value = data.id;
      document.getElementById('edit_name').value = data.name || '';
      document.getElementById('edit_species').value = data.species || '';
      document.getElementById('edit_breed').value = data.breed || '';
      document.getElementById('edit_sex').value = data.sex || '';
      document.getElementById('edit_size').value = data.size || '';
      document.getElementById('edit_notes').value = data.special_needs || '';
      document.getElementById('edit_photo_url').value = data.photo_url || '';
      editModal.classList.add('show');
  };

  function closeEdit(){ editModal.classList.remove('show'); }
  document.getElementById('closeEdit').onclick = closeEdit;
  document.getElementById('cancelEdit').onclick = closeEdit;
  editModal.addEventListener('click', (e)=>{ if(e.target.id === 'editModal') closeEdit(); });

  document.getElementById('saveEdit').onclick = async () => {
      const id = document.getElementById('edit_id').value;
      const updates = {
          name: document.getElementById('edit_name').value.trim(),
          species: document.getElementById('edit_species').value.trim(),
          breed: document.getElementById('edit_breed').value.trim() || null,
          sex: document.getElementById('edit_sex').value || null,
          size: document.getElementById('edit_size').value || null,
          special_needs: document.getElementById('edit_notes').value.trim() || null,
          photo_url: document.getElementById('edit_photo_url').value.trim() || null
      };
      if(!updates.name || !updates.species){
        toast('Informe pelo menos Nome e Esp√©cie.');
        return;
      }
      const { error } = await sb.from('pets').update(updates).eq('id', id);
      if(error) { toast('Erro ao salvar.'); }
      else {
          toast('Pet atualizado!');
          closeEdit();
          const { data:{ user } } = await sb.auth.getUser();
          loadPets(user);
      }
  };

  // ========== 5. EXCLUIR CONTA (REDIRECIONA PHP) ==========
  const ppDelete = document.getElementById('ppDelete');
  const delOk = document.getElementById('delOk');
  const delCancel = document.getElementById('delCancel');
  const delInput = document.getElementById('delConfirmText');

  deleteAccountLink.addEventListener('click', (e)=>{
    e.preventDefault();
    ppDelete.style.display = 'flex';
    requestAnimationFrame(()=>ppDelete.querySelector('.pp-card').classList.add('show'));
  });

  delCancel.addEventListener('click', ()=>{
    ppDelete.querySelector('.pp-card').classList.remove('show');
    setTimeout(()=>ppDelete.style.display='none',140);
  });

  delOk.addEventListener('click', ()=>{
    if(delInput.value === 'EXCLUIR'){
      window.location.href = 'processaExclusao.php';
    } else {
      alert('Por favor, digite EXCLUIR corretamente.');
    }
  });

  // ========== BOOT ==========
  (async function(){
      const user = await initUser();
      if(user) await loadPets(user);
  })();
</script>
</body>
</html>
