<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu de Perfil • Patas Pousada</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Parkinsans:wght@600;700&display=swap');
    :root{
      --brand:#e2725b;--brand-strong:#d45f47;--bg:#f7f7f7;--ink:#111;
      --line:#eee;--shadow:0 8px 20px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Nunito,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* HEADER */
    header{background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.08)}
    .nav{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:18px}
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--brand);font:700 20px Parkinsans,sans-serif}
    .logo img{width:30px;height:30px}
    .nav ul{list-style:none;display:flex;gap:24px;margin-left:auto;margin-right:8px}
    .nav a.link{font:700 16px Parkinsans,sans-serif;color:#222;text-decoration:none}
    .nav a.link:hover{color:var(--brand)}

    /* USER MENU */
    .user{
      position:relative;
      display:flex;
      align-items:center;
    }
    .user__trigger{display:flex;align-items:center;gap:8px;cursor:pointer}
    .badge{
      width:28px;height:28px;border-radius:50%;
      background:#ffe6e6;display:grid;place-items:center;
      color:#c54a34;font-weight:800;font-size:.85rem;
    }
    .user__trigger span{
      max-width:160px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:800;
    }

    .user__dropdown{
      position:absolute;
      top:100%;          /* cola embaixo do trigger */
      right:0;
      margin-top:4px;    /* espacinho pequeno */
      background:#fff;
      border:1px solid #eee;
      border-radius:12px;
      box-shadow:var(--shadow);
      min-width:220px;
      display:none;
      padding:8px;
      z-index:20;
    }
    .user:hover .user__dropdown{display:block}

    .user__item{
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:10px;
      color:#111;text-decoration:none;font-weight:800;
    }
    .user__item:hover{background:#f7f7f7}
    .dropdown-sep{height:1px;background:#eee;margin:6px 0}
    .pp-danger{color:#b91c1c}

    /* CONTEÚDO */
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .title{font:800 26px Parkinsans,sans-serif;color:#222;text-align:center;margin-bottom:6px}
    .lead{color:#6b7280;text-align:center;margin-bottom:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px}
    .card{
      background:#fff;border:1px solid #eee;border-radius:14px;
      box-shadow:0 1px 3px rgba(0,0,0,.04);
      padding:18px;display:flex;gap:12px;align-items:flex-start;
      text-decoration:none;color:#111;
      transition:transform .08s, box-shadow .2s;
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .card h3{font:800 18px Parkinsans,sans-serif;margin-bottom:6px}
    .card p{color:#6b7280;font-size:14px}
    .carret{margin-left:auto;color:#aaa;font-weight:900}

    /* MODAL EXCLUIR CONTA */
    .pp-wrap{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;z-index:60}
    .pp-card{width:min(460px,92vw);background:#fff;border-radius:18px;box-shadow:0 30px 80px rgba(0,0,0,.35);overflow:hidden;transform:translateY(8px);opacity:0;transition:.18s}
    .pp-card.show{transform:translateY(0);opacity:1}
    .pp-card header{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #f1f5f9;background:#fff1f0}
    .pp-card header .ic{width:20px;height:20px;display:grid;place-items:center;border-radius:999px;background:#fee2e2;color:#b91c1c;font-weight:900}
    .pp-card h4{margin:0;font-weight:900;color:#991b1b}
    .pp-body{padding:16px}
    .pp-body p{margin-bottom:8px}
    .pp-body input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin:6px 0 10px}
    .pp-ft{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;background:#fafafa;border-top:1px solid #eef2f7}
    .pp-btn{border-radius:12px;padding:9px 14px;font-weight:900;border:2px solid #e2e8f0;background:#fff;cursor:pointer}
    .pp-ok{background:#b91c1c;color:#fff;border-color:#b91c1c}

    /* TOAST */
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.25);font-size:.92rem;display:none;z-index:70}
  </style>

  <!-- Supabase SDK (SEM defer) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <nav class="nav">
    <a class="logo" href="index.html">
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="">
      Patas Pousada
    </a>
    <ul>
      <li><a class="link" href="reservas.html">Reservas</a></li>
      <li><a class="link" href="ajuda.html">Ajuda</a></li>
      <li><a class="link" href="Lartemp.html" style="color:#d74f4f">Lar Temporário</a></li>
    </ul>
    <div class="user" id="userMenuRoot">
      <div class="user__trigger">
        <div class="badge" id="userInitial">U</div>
        <span id="userName">Usuário</span>
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#666" d="M7 10l5 5 5-5z"/></svg>
      </div>
      <div class="user__dropdown">
        <a class="user__item" href="menu_perfil.html"><i class="fa-solid fa-user-pen"></i> Editar perfil</a>
        <a class="user__item" href="meusPets.html"><i class="fa-solid fa-paw"></i> Meus pets</a>
        <a class="user__item" href="#" id="btnLogout"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</a>
        <div class="dropdown-sep"></div>
        <a class="user__item pp-danger" href="#" id="deleteAccountLink">
          <i class="fa-solid fa-user-xmark"></i> Excluir conta
        </a>
      </div>
    </div>
  </nav>
</header>

<main class="wrap">
  <h1 class="title">Editar perfil</h1>
  <p class="lead">Edite suas informações e preferências, faça a gestão dos seus preços e perfil.</p>

  <div class="grid">
    <a class="card" href="editarperfil.html">
      <img src="https://www.centrodemedicina.com.br/wp-content/uploads/2021/07/personal-information.png" width="38" height="38" alt="">
      <div>
        <h3>Dados pessoais</h3>
        <p>Ajuste dados, endereço, documentos, telefones e contatos de emergência.</p>
      </div>
      <div class="carret">›</div>
    </a>

    <a class="card" href="meusPets.html">
      <img src="https://cdn-icons-png.flaticon.com/512/5184/5184018.png" width="38" height="38" alt="">
      <div>
        <h3>Seus pets</h3>
        <p>Edite ou adicione seus pets.</p>
      </div>
      <div class="carret">›</div>
    </a>

    <a class="card" href="alterar-senha.html">
      <img src="https://cdn-icons-png.flaticon.com/512/16794/16794845.png" width="38" height="38" alt="">
      <div>
        <h3>Configurações</h3>
        <p>Redefina sua senha de acesso.</p>
      </div>
      <div class="carret">›</div>
    </a>
  </div>
</main>

<!-- MODAL: Excluir conta -->
<div class="pp-wrap" id="ppDelete" style="display:none">
  <div class="pp-card" role="dialog" aria-modal="true">
    <header>
      <span class="ic">!</span>
      <h4>Excluir sua conta</h4>
    </header>
    <div class="pp-body">
      <p>Esta ação é <strong>irreversível</strong>. Todos os seus dados (perfil, pets, reservas, arquivos) serão removidos.</p>
      <p>Para confirmar, digite <strong>EXCLUIR</strong>:</p>
      <input id="delConfirmText" type="text" placeholder="EXCLUIR">
      <p>Por segurança, informe sua <strong>senha atual</strong>:</p>
      <input id="delPassword" type="password" placeholder="Senha atual">
    </div>
    <div class="pp-ft">
      <button class="pp-btn" id="delCancel">Cancelar</button>
      <button class="pp-btn pp-ok" id="delOk">Sim, excluir</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userNameEl    = document.getElementById('userName');
  const userInitialEl = document.getElementById('userInitial');
  const btnLogout     = document.getElementById('btnLogout');
  const deleteAccountLink = document.getElementById('deleteAccountLink');

  function toast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg; t.style.display='block';
    setTimeout(()=>t.style.display='none',2200);
  }

  function initialsFromName(name){
    if(!name) return 'U';
    const parts = name.trim().split(/\s+/);
    const p1 = parts[0]?.[0] || '';
    const p2 = parts[1]?.[0] || '';
    const ini = (p1 + p2).toUpperCase();
    return ini || 'U';
  }

  async function initUser(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){
      location.href = "cadastrarouentrar.html?next=menu_perfil.html";
      return null;
    }

    const emailPrefix = user.email.split('@')[0];
    let display = emailPrefix;

    try{
      const { data } = await sb
        .from('profiles')
        .select('full_name')
        .eq('id', user.id)
        .maybeSingle();

      if(data?.full_name && data.full_name.trim() !== ''){
        display = data.full_name;
      }
    }catch(e){
      console.error('Erro buscando profile:', e);
    }

    if((display === emailPrefix || !display) && user.user_metadata?.full_name){
      display = user.user_metadata.full_name;
    }

    userNameEl.textContent    = display || emailPrefix;
    userInitialEl.textContent = initialsFromName(display || emailPrefix);

    return user;
  }

  btnLogout.addEventListener('click', async (e)=>{
    e.preventDefault();
    await sb.auth.signOut();
    location.href = "index.html";
  });

  // ===== Modal excluir conta (UI) =====
  const ppDelete       = document.getElementById('ppDelete');
  const delCancel      = document.getElementById('delCancel');
  const delOk          = document.getElementById('delOk');
  const delConfirmText = document.getElementById('delConfirmText');
  const delPassword    = document.getElementById('delPassword');

  function openDeleteModal(){
    ppDelete.style.display='flex';
    requestAnimationFrame(()=>ppDelete.querySelector('.pp-card').classList.add('show'));
    setTimeout(()=>delConfirmText?.focus(), 80);
  }
  function closeDeleteModal(){
    ppDelete.querySelector('.pp-card').classList.remove('show');
    setTimeout(()=>{ ppDelete.style.display='none'; }, 140);
    delConfirmText.value=''; delPassword.value='';
  }

  deleteAccountLink?.addEventListener('click', (e)=>{
    e.preventDefault();
    openDeleteModal();
  });
  delCancel?.addEventListener('click', closeDeleteModal);
  ppDelete?.addEventListener('click', e=>{ if(e.target.id==='ppDelete') closeDeleteModal(); });

  delOk?.addEventListener('click', ()=>{
    const okWord = delConfirmText.value.trim().toUpperCase() === 'EXCLUIR';
    if(!okWord){ toast('Digite EXCLUIR para confirmar.'); delConfirmText.focus(); return; }
    if(!delPassword.value.trim()){ toast('Informe sua senha atual.'); delPassword.focus(); return; }
    toast('Confirmação recebida. (Implementar exclusão real depois)');
    closeDeleteModal();
  });

  // boot
  (async ()=>{
    await initUser();
  })();
</script>
</body>
</html>
